# ============================================
# Nginx Configuration for DripEmails.org
# ============================================
# This configuration works with uWSGI running on 127.0.0.1:8000
# Place this file in /etc/nginx/sites-available/dripemails
# Then create a symlink: sudo ln -s /etc/nginx/sites-available/dripemails /etc/nginx/sites-enabled/
#
# Note: Let's Encrypt (certbot) will automatically add HTTPS configuration
# Run: sudo certbot --nginx -d dripemails.org -d www.dripemails.org -d api.dripemails.org -d docs.dripemails.org

# HTTP server block (port 80)
server {
    listen 80;
    listen [::]:80;
    server_name dripemails.org www.dripemails.org api.dripemails.org docs.dripemails.org web.dripemails.org;
    
    # ============================================
    # Logging
    # ============================================
    access_log /var/log/nginx/dripemails-access.log;
    error_log /var/log/nginx/dripemails-error.log;
    
    # ============================================
    # Client Settings
    # ============================================
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    client_body_timeout 60s;
    client_header_timeout 60s;
    send_timeout 60s;
    
    # ============================================
    # Security Headers (basic, certbot will add more for HTTPS)
    # ============================================
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # ============================================
    # Static Files
    # ============================================
    location /static/ {
        alias /home/dripemails/web/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # ============================================
    # Media Files
    # ============================================
    location /media/ {
        alias /home/dripemails/web/media/;
        expires 7d;
        add_header Cache-Control "public";
        access_log off;
    }
    
    # ============================================
    # Favicon and robots.txt
    # ============================================
    location = /favicon.ico {
        alias /home/dripemails/web/staticfiles/favicon.ico;
        access_log off;
        log_not_found off;
    }
    
    location = /robots.txt {
        alias /home/dripemails/web/staticfiles/robots.txt;
        access_log off;
        log_not_found off;
    }
    
    # ============================================
    # uWSGI Proxy Configuration
    # ============================================
    location / {
        include uwsgi_params;
        uwsgi_pass 127.0.0.1:8000;
        
        # uWSGI parameters
        uwsgi_param Host $host;
        uwsgi_param X-Real-IP $remote_addr;
        uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
        uwsgi_param X-Forwarded-Proto $scheme;
        uwsgi_param X-Forwarded-Host $server_name;
        uwsgi_param SCRIPT_NAME '';
        
        # Timeouts
        uwsgi_connect_timeout 60s;
        uwsgi_send_timeout 60s;
        uwsgi_read_timeout 60s;
        
        # Buffer settings
        uwsgi_buffering off;
        uwsgi_buffer_size 4k;
        uwsgi_buffers 8 4k;
        uwsgi_busy_buffers_size 8k;
        
        # Don't buffer responses
        proxy_buffering off;
    }
    
    # ============================================
    # Health Check Endpoint (optional)
    # ============================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # ============================================
    # Deny access to hidden files
    # ============================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}


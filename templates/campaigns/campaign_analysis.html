{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Campaign Analysis" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold">{% trans "Campaign Analysis" %}</h1>
    <div>
      <a href="{% url 'campaigns:abtest' %}" class="text-indigo-600 hover:text-indigo-800">{% trans "AB Test" %}</a>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm p-6">
    <form method="get" class="mb-6">
      <label class="flex items-center space-x-3">
        <span class="text-sm text-gray-600">{% trans "Campaign" %}</span>
        <select name="campaign_id" onchange="this.form.submit()" class="ml-2 border rounded px-3 py-2">
          <option value="">-- {% trans "Select" %} --</option>
          {% for c in campaigns %}
            <option value="{{ c.id }}" {% if campaign and campaign.id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>
    </form>

    {% if not campaign %}
      <p class="text-gray-600">{% trans "Select a campaign to view analysis." %}</p>
    {% else %}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Sent" %}</div>
          <div class="text-xl font-semibold">{{ campaign.sent_count }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Opens" %}</div>
          <div class="text-xl font-semibold">{{ campaign.open_count }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Clicks" %}</div>
          <div class="text-xl font-semibold">{{ campaign.click_count }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Open Rate" %}</div>
          <div class="text-xl font-semibold">{{ campaign.open_rate|default:"0%" }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Click Rate" %}</div>
          <div class="text-xl font-semibold">{{ campaign.click_rate|default:"0%" }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Delivery Rate" %}</div>
          <div class="text-xl font-semibold">{{ campaign.delivery_rate|default:"0%" }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Bounces" %}</div>
          <div class="text-xl font-semibold">{{ campaign.bounce_count|default:0 }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Unsubscribes" %}</div>
          <div class="text-xl font-semibold">{{ campaign.unsubscribe_count|default:0 }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Complaints" %}</div>
          <div class="text-xl font-semibold">{{ campaign.complaint_count|default:0 }}</div>
        </div>
      </div>

      <!-- Metrics chart -->
      <div class="mb-6">
        <h2 class="text-lg font-medium mb-2">{% trans "Metrics Overview" %}</h2>
        <canvas id="metricsChart" width="400" height="200"></canvas>
        <!-- Additional small rate charts (placeholders) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div class="p-2 bg-white rounded border text-center">
            <h3 class="text-sm text-gray-600">{% trans "Open Rate (trend)" %}</h3>
            <canvas id="openRateChart" width="300" height="120"></canvas>
          </div>
          <div class="p-2 bg-white rounded border text-center">
            <h3 class="text-sm text-gray-600">{% trans "Click Rate (trend)" %}</h3>
            <canvas id="clickRateChart" width="300" height="120"></canvas>
          </div>
          <div class="p-2 bg-white rounded border text-center">
            <h3 class="text-sm text-gray-600">{% trans "Delivery Rate (trend)" %}</h3>
            <canvas id="deliveryChart" width="300" height="120"></canvas>
          </div>
        </div>
      </div>

      <!-- Monthly events chart -->
      <div class="mb-6">
        <h2 class="text-lg font-medium mb-2">{% trans "Monthly events" %}</h2>
        {% if by_month_items %}
          <canvas id="monthlyChart" width="800" height="300"></canvas>
          <!-- additional monthly metric placeholders -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="p-4 bg-white rounded border text-center">
              <h3 class="text-sm text-gray-600">{% trans "Monthly Bounces" %}</h3>
              <canvas id="monthlyBouncesChart" width="400" height="120"></canvas>
            </div>
            <div class="p-4 bg-white rounded border text-center">
              <h3 class="text-sm text-gray-600">{% trans "Monthly Unsubscribes" %}</h3>
              <canvas id="monthlyUnsubsChart" width="400" height="120"></canvas>
            </div>
            <div class="p-4 bg-white rounded border text-center">
              <h3 class="text-sm text-gray-600">{% trans "Monthly Complaints" %}</h3>
              <canvas id="monthlyComplaintsChart" width="400" height="120"></canvas>
            </div>
          </div>
          <div class="overflow-auto bg-white rounded border mt-4">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Month" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Sent" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Opened" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Clicked" %}</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for month, vals in by_month_items %}
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ month }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ vals.sent }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ vals.opened }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ vals.clicked }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-600">{% trans "No events found for this campaign." %}</p>
        {% endif %}
      </div>

      <!-- Per-email breakdown chart and table -->
      <div>
        <h2 class="text-lg font-medium mb-2">{% trans "Per-email breakdown" %}</h2>
        {% if email_rows %}
          <canvas id="perEmailChart" width="800" height="300" class="mb-4"></canvas>
          <!-- per-email rate placeholders -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="p-4 bg-white rounded border text-center">
              <h3 class="text-sm text-gray-600">{% trans "Per-email Open Rate" %}</h3>
              <canvas id="perEmailOpenRateChart" width="400" height="120"></canvas>
            </div>
            <div class="p-4 bg-white rounded border text-center">
              <h3 class="text-sm text-gray-600">{% trans "Per-email Click Rate" %}</h3>
              <canvas id="perEmailClickRateChart" width="400" height="120"></canvas>
            </div>
          </div>
          <div class="overflow-auto bg-white rounded border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Subject" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Sent" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Opened" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Clicked" %}</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for r in email_rows %}
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.subject }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.sent }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.opened }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.clicked }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-600">{% trans "No emails found for this campaign." %}</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'chart.min.js' %}"></script>
  <script src="{% static 'campaigns/js/campaigns-charts.js' %}"></script>
  <script type="text/template" id="chart-data">
    {
      "metrics": {
        "sent": "{{ campaign.sent_count|default:0 }}",
        "opens": "{{ campaign.open_count|default:0 }}",
        "clicks": "{{ campaign.click_count|default:0 }}",
        "open_rate": "{{ campaign.open_rate|default:0 }}",
        "click_rate": "{{ campaign.click_rate|default:0 }}",
        "delivery_rate": "{{ campaign.delivery_rate|default:0 }}",
        "bounces": "{{ campaign.bounce_count|default:0 }}",
        "unsubscribes": "{{ campaign.unsubscribe_count|default:0 }}",
        "complaints": "{{ campaign.complaint_count|default:0 }}"
      },
      "monthly": {
        "months": [{% for month, vals in by_month_items %}"{{ month }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        "sent": [{% for month, vals in by_month_items %}{{ vals.sent|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "opens": [{% for month, vals in by_month_items %}{{ vals.opened|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "clicks": [{% for month, vals in by_month_items %}{{ vals.clicked|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "bounces": [{% for month, vals in by_month_items %}{{ vals.bounces|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "unsubscribes": [{% for month, vals in by_month_items %}{{ vals.unsubscribes|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "complaints": [{% for month, vals in by_month_items %}{{ vals.complaints|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}]
      },
      "email": {
        "labels": [{% for r in email_rows %}"{{ r.subject|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        "sent": [{% for r in email_rows %}{{ r.sent|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "opens": [{% for r in email_rows %}{{ r.opened|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "clicks": [{% for r in email_rows %}{{ r.clicked|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "open_rate": [{% for r in email_rows %}{{ r.open_rate|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "click_rate": [{% for r in email_rows %}{{ r.click_rate|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}]
      }
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var chartDataEl = document.getElementById('chart-data');
      var data = JSON.parse(chartDataEl.innerHTML);
      
      var metricsCanvas = document.getElementById('metricsChart');
      if (metricsCanvas) {
        metricsCanvas.dataset.sent = data.metrics.sent;
        metricsCanvas.dataset.opens = data.metrics.opens;
        metricsCanvas.dataset.clicks = data.metrics.clicks;
        metricsCanvas.dataset.open_rate = data.metrics.open_rate||0;
        metricsCanvas.dataset.click_rate = data.metrics.click_rate||0;
        metricsCanvas.dataset.delivery_rate = data.metrics.delivery_rate||0;
        metricsCanvas.dataset.bounces = data.metrics.bounces||0;
        metricsCanvas.dataset.unsubscribes = data.metrics.unsubscribes||0;
        metricsCanvas.dataset.complaints = data.metrics.complaints||0;
      }
      
      var monthlyCanvas = document.getElementById('monthlyChart');
      if (monthlyCanvas) {
        monthlyCanvas.dataset.months = JSON.stringify(data.monthly.months);
        monthlyCanvas.dataset.sent = JSON.stringify(data.monthly.sent);
        monthlyCanvas.dataset.opens = JSON.stringify(data.monthly.opens);
        monthlyCanvas.dataset.clicks = JSON.stringify(data.monthly.clicks);
        monthlyCanvas.dataset.bounces = JSON.stringify(data.monthly.bounces||[]);
        monthlyCanvas.dataset.unsubscribes = JSON.stringify(data.monthly.unsubscribes||[]);
        monthlyCanvas.dataset.complaints = JSON.stringify(data.monthly.complaints||[]);
      }
      
      var perEmailCanvas = document.getElementById('perEmailChart');
      if (perEmailCanvas) {
        perEmailCanvas.dataset.labels = JSON.stringify(data.email.labels);
        perEmailCanvas.dataset.sent = JSON.stringify(data.email.sent);
        perEmailCanvas.dataset.opens = JSON.stringify(data.email.opens);
        perEmailCanvas.dataset.clicks = JSON.stringify(data.email.clicks);
        perEmailCanvas.dataset.open_rate = JSON.stringify(data.email.open_rate||[]);
        perEmailCanvas.dataset.click_rate = JSON.stringify(data.email.click_rate||[]);
      }

      // small-rate charts and placeholders
      var openRateCanvas = document.getElementById('openRateChart');
      if (openRateCanvas) {
        openRateCanvas.dataset.months = JSON.stringify(data.monthly.months||[]);
        openRateCanvas.dataset.values = JSON.stringify(data.monthly.opens||[]);
      }
      var clickRateCanvas = document.getElementById('clickRateChart');
      if (clickRateCanvas) {
        clickRateCanvas.dataset.months = JSON.stringify(data.monthly.months||[]);
        clickRateCanvas.dataset.values = JSON.stringify(data.monthly.clicks||[]);
      }
      var deliveryCanvas = document.getElementById('deliveryChart');
      if (deliveryCanvas) {
        deliveryCanvas.dataset.months = JSON.stringify(data.monthly.months||[]);
        deliveryCanvas.dataset.values = JSON.stringify(data.monthly.sent||[]);
      }

      var monthlyBounces = document.getElementById('monthlyBouncesChart');
      if (monthlyBounces) monthlyBounces.dataset.values = JSON.stringify(data.monthly.bounces||[]);
      var monthlyUnsubs = document.getElementById('monthlyUnsubsChart');
      if (monthlyUnsubs) monthlyUnsubs.dataset.values = JSON.stringify(data.monthly.unsubscribes||[]);
      var monthlyComplaints = document.getElementById('monthlyComplaintsChart');
      if (monthlyComplaints) monthlyComplaints.dataset.values = JSON.stringify(data.monthly.complaints||[]);

      var perEmailOpenRate = document.getElementById('perEmailOpenRateChart');
      if (perEmailOpenRate) perEmailOpenRate.dataset.values = JSON.stringify(data.email.open_rate||[]);
      var perEmailClickRate = document.getElementById('perEmailClickRateChart');
      if (perEmailClickRate) perEmailClickRate.dataset.values = JSON.stringify(data.email.click_rate||[]);
    });
  </script>
{% endblock %}

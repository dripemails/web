{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Campaign Analysis" %} - {{ block.super }}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold">{% trans "Campaign Analysis" %}</h1>
    <div>
      <a href="{% url 'campaigns:template_revision' %}{% if agent %}?agent={{ agent }}{% endif %}" class="text-indigo-600 hover:text-indigo-800">{% trans "Template Revision" %}</a>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm p-6">
    <form method="get" class="mb-6">
      {% if agent %}
      <input type="hidden" name="agent" value="{{ agent }}">
      {% endif %}
      <label class="flex items-center space-x-3">
        <span class="text-sm text-gray-600">{% trans "Campaign" %}</span>
        <select name="campaign_id" onchange="this.form.submit()" class="ml-2 border rounded px-3 py-2">
          <option value="">-- {% trans "Select" %} --</option>
          {% for c in campaigns %}
            <option value="{{ c.id }}" {% if campaign and campaign.id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>
    </form>

    {% if not campaign %}
      <p class="text-gray-600">{% trans "Select a campaign to view analysis." %}</p>
    {% else %}
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-900">{% trans "Campaign Statistics" %}</h2>
        <div id="stats-timestamp" class="text-sm text-gray-500">{% trans "Loading..." %}</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Sent" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="sent">{{ campaign.sent_count }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Opens" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="opens">{{ campaign.open_count }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Clicks" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="clicks">{{ campaign.click_count }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Open Rate" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="open_rate">{{ campaign.open_rate|default:"0%" }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Click Rate" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="click_rate">{{ campaign.click_rate|default:"0%" }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Delivery Rate" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="delivery_rate">{{ campaign.delivery_rate|default:"0%" }}</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Bounces" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="bounces">{{ campaign.bounce_count|default:0 }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Unsubscribes" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="unsubscribes">{{ campaign.unsubscribe_count|default:0 }}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded border">
          <div class="text-sm text-gray-500">{% trans "Complaints" %}</div>
          <div class="text-xl font-semibold text-gray-900" data-metric="complaints">{{ campaign.complaint_count|default:0 }}</div>
        </div>
      </div>

      <!-- Metrics chart -->
      <div class="mb-6">
        <h2 class="text-lg font-medium mb-2">{% trans "Past 7 Days Trends" %}</h2>
        <!-- Rate charts with data -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 bg-white rounded border">
            <h3 class="text-sm text-gray-600 mb-2">{% trans "Delivery Rate" %}</h3>
            <div style="height: 150px; position: relative;">
              <canvas id="deliveryRateChart"></canvas>
            </div>
          </div>
          <div class="p-4 bg-white rounded border">
            <h3 class="text-sm text-gray-600 mb-2">{% trans "Open Rate" %}</h3>
            <div style="height: 150px; position: relative;">
              <canvas id="openRateChart"></canvas>
            </div>
          </div>
          <div class="p-4 bg-white rounded border">
            <h3 class="text-sm text-gray-600 mb-2">{% trans "Click-Through Rate" %}</h3>
            <div style="height: 150px; position: relative;">
              <canvas id="clickRateChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly events chart -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">{% trans "Monthly events" %}</h2>
        {% if by_month_items %}
          <div class="overflow-auto bg-white rounded border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Month" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Sent" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Opened" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Clicked" %}</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for month, vals in by_month_items %}
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ month }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ vals.sent }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ vals.opened }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ vals.clicked }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-600">{% trans "No events found for this campaign." %}</p>
        {% endif %}
      </div>

      <!-- Per-email breakdown chart and table -->
      <div>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">{% trans "Per-email breakdown" %}</h2>
        {% if email_rows %}
          <div class="overflow-auto bg-white rounded border">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Subject" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Sent" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Opened" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Clicked" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Open Rate" %}</th>
                  <th class="px-4 py-2 text-left text-sm text-gray-600">{% trans "Click Rate" %}</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for r in email_rows %}
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.subject }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.sent }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.opened }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.clicked }}</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.open_rate }}%</td>
                  <td class="px-4 py-2 text-sm text-gray-700">{{ r.click_rate }}%</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-600">{% trans "No emails found for this campaign." %}</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script>
    console.log('Script loaded');
    
    // Real-time statistics auto-refresh
    let lastUpdated = new Date();
    let refreshInterval = 15000; // 15 seconds
    let campaignId = '{{ campaign.id|default:"" }}';
    const weeklyAnalyticsBaseUrl = '{% url "analytics:weekly" %}';
    const campaignStatsBaseUrl = '/api/campaigns/';
    const agentParam = '{{ agent|default:""|escapejs }}';
    
    console.log('Campaign ID from template:', campaignId);
    
    // Store chart instances globally so we can update them
    let deliveryChart = null;
    let openChart = null;
    let clickChart = null;

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      console.log('Campaign ID:', campaignId);
      
      // Initialize weekly analytics charts for this campaign
      if (campaignId) {
        console.log('Calling initWeeklyAnalyticsCharts...');
        initWeeklyAnalyticsCharts(campaignId);
      } else {
        console.warn('No campaign ID available');
      }
      
      // Start auto-refresh if campaign is active
      if (campaignId) {
        // Update timestamp every second
        setInterval(updateTimestamp, 1000);
        
        // Refresh statistics every 15 seconds
        setInterval(updateStatistics, refreshInterval);
        
        // Initial update after 5 seconds
        setTimeout(updateStatistics, 5000);
      }
    });

    function initWeeklyAnalyticsCharts(campaignId) {
      console.log('Initializing charts for campaign:', campaignId);
      
      // Fetch weekly analytics data for this specific campaign
      const query = new URLSearchParams({ campaign_id: campaignId });
      if (agentParam) {
        query.set('agent', agentParam);
      }
      fetch(`${weeklyAnalyticsBaseUrl}?${query.toString()}`)
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Weekly data received:', data);
          const weeklyData = data.weekly_data || [];
          console.log('Processed weekly data:', weeklyData);
          
          // Extract data for charts
          const dates = weeklyData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          });
          const deliveryRates = weeklyData.map(d => d.delivery_rate);
          const openRates = weeklyData.map(d => d.open_rate);
          const clickRates = weeklyData.map(d => d.click_rate);
          
          console.log('Chart data:', { dates, deliveryRates, openRates, clickRates });
          
          // Common chart options
          const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  },
                  font: {
                    size: 10
                  }
                },
                grid: {
                  display: true
                }
              },
              x: {
                ticks: {
                  font: {
                    size: 10
                  }
                },
                grid: {
                  display: false
                }
              }
            }
          };
          
          // Delivery Rate Chart
          const deliveryRateCtx = document.getElementById('deliveryRateChart');
          console.log('Delivery Rate Canvas:', deliveryRateCtx);
          if (deliveryRateCtx) {
            if (deliveryChart) {
              deliveryChart.destroy();
            }
            console.log('Creating delivery rate chart...');
            deliveryChart = new Chart(deliveryRateCtx.getContext('2d'), {
              type: 'line',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Delivery Rate',
                  data: deliveryRates,
                  borderColor: 'rgb(59, 130, 246)',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: commonOptions
            });
            console.log('Delivery chart created:', deliveryChart);
          } else {
            console.error('Delivery Rate Canvas not found!');
          }
          
          // Open Rate Chart
          const openRateCtx = document.getElementById('openRateChart');
          console.log('Open Rate Canvas:', openRateCtx);
          if (openRateCtx) {
            if (openChart) {
              openChart.destroy();
            }
            console.log('Creating open rate chart...');
            openChart = new Chart(openRateCtx.getContext('2d'), {
              type: 'line',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Open Rate',
                  data: openRates,
                  borderColor: 'rgb(16, 185, 129)',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: commonOptions
            });
            console.log('Open chart created:', openChart);
          } else {
            console.error('Open Rate Canvas not found!');
          }
          
          // Click-Through Rate Chart
          const clickRateCtx = document.getElementById('clickRateChart');
          console.log('Click Rate Canvas:', clickRateCtx);
          if (clickRateCtx) {
            if (clickChart) {
              clickChart.destroy();
            }
            console.log('Creating click rate chart...');
            clickChart = new Chart(clickRateCtx.getContext('2d'), {
              type: 'line',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Click-Through Rate',
                  data: clickRates,
                  borderColor: 'rgb(245, 158, 11)',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: commonOptions
            });
            console.log('Click chart created:', clickChart);
          } else {
            console.error('Click Rate Canvas not found!');
          }
        })
        .catch(error => {
          console.error('Error loading weekly analytics:', error);
        });
    }

    function updateStatistics() {
      const query = new URLSearchParams();
      if (agentParam) {
        query.set('agent', agentParam);
      }
      const statsUrl = `${campaignStatsBaseUrl}${encodeURIComponent(campaignId)}/stats/${query.toString() ? `?${query.toString()}` : ''}`;
      fetch(statsUrl)
        .then(response => {
          if (!response.ok) throw new Error('Failed to fetch stats');
          return response.json();
        })
        .then(data => {
          // Update metric cards
          const sentEl = document.querySelector('[data-metric="sent"]');
          const opensEl = document.querySelector('[data-metric="opens"]');
          const clicksEl = document.querySelector('[data-metric="clicks"]');
          const openRateEl = document.querySelector('[data-metric="open_rate"]');
          const clickRateEl = document.querySelector('[data-metric="click_rate"]');
          const deliveryRateEl = document.querySelector('[data-metric="delivery_rate"]');
          const bouncesEl = document.querySelector('[data-metric="bounces"]');
          const unsubscribesEl = document.querySelector('[data-metric="unsubscribes"]');
          const complaintsEl = document.querySelector('[data-metric="complaints"]');

          if (sentEl) sentEl.textContent = data.overall_stats.sent_count || 0;
          if (opensEl) opensEl.textContent = data.overall_stats.open_count || 0;
          if (clicksEl) clicksEl.textContent = data.overall_stats.click_count || 0;
          if (openRateEl) openRateEl.textContent = `${(data.overall_stats.open_rate || 0).toFixed(1)}%`;
          if (clickRateEl) clickRateEl.textContent = `${(data.overall_stats.click_rate || 0).toFixed(1)}%`;
          if (deliveryRateEl) deliveryRateEl.textContent = `${(data.overall_stats.delivery_rate || 0).toFixed(1)}%`;
          if (bouncesEl) bouncesEl.textContent = data.overall_stats.bounce_count || 0;
          if (unsubscribesEl) unsubscribesEl.textContent = data.overall_stats.unsubscribe_count || 0;
          if (complaintsEl) complaintsEl.textContent = data.overall_stats.complaint_count || 0;

          // Update last updated timestamp
          lastUpdated = new Date();
          updateTimestamp();
          
          // Refresh charts with latest data
          if (campaignId) {
            initWeeklyAnalyticsCharts(campaignId);
          }

          console.log('Campaign stats refreshed:', data);
        })
        .catch(error => {
          console.error('Error refreshing stats:', error);
        });
    }

    function updateTimestamp() {
      const now = new Date();
      const secondsAgo = Math.floor((now - lastUpdated) / 1000);
      const timestampEl = document.getElementById('stats-timestamp');
      
      if (timestampEl) {
        if (secondsAgo < 60) {
          timestampEl.textContent = `Updated ${secondsAgo}s ago`;
        } else {
          const minutesAgo = Math.floor(secondsAgo / 60);
          timestampEl.textContent = `Updated ${minutesAgo}m ago`;
        }
      }
    }
  </script>
{% endblock %}

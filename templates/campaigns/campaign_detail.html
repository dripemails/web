{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ campaign.name }} - {% trans "Campaign Detail" %}{% endblock %}

{% block extra_css %}
<style>
    .email-item {
        transition: all 0.3s ease;
    }
    .email-item:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .email-content-expanded {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .email-content-expanded.show {
        max-height: 1000px;
        transition: max-height 0.5s ease-in;
    }
    .rotate-icon {
        transition: transform 0.3s ease;
    }
    .rotate-icon.rotated {
        transform: rotate(180deg);
    }
    .send-btn {
        transition: all 0.2s ease;
    }
    .send-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Campaign Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-4xl font-bold text-gray-900">{{ campaign.name }}</h1>
            <div class="flex gap-3">
                <a href="{% url 'campaigns:edit' campaign.id %}" 
                   class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    {% trans "Edit Campaign" %}
                </a>
                <a href="{% url 'core:dashboard' %}" 
                   class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    {% trans "Back to Dashboard" %}
                </a>
            </div>
        </div>
        
        <!-- Campaign Info Card -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <p class="text-sm text-gray-600">{% trans "Status" %}</p>
                    <p class="text-lg font-semibold">
                        {% if campaign.is_active %}
                            <span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-800">{% trans "Active" %}</span>
                        {% else %}
                            <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800">{% trans "Inactive" %}</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">{% trans "Sent Count" %}</p>
                    <p class="text-2xl font-bold text-indigo-600">{{ campaign.sent_count }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">{% trans "Open Rate" %}</p>
                    <p class="text-2xl font-bold text-green-600">{{ campaign.open_rate|floatformat:1 }}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">{% trans "Click Rate" %}</p>
                    <p class="text-2xl font-bold text-blue-600">{{ campaign.click_rate|floatformat:1 }}%</p>
                </div>
            </div>
            {% if campaign.description %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-600">{% trans "Description" %}</p>
                <p class="text-gray-800 mt-1">{{ campaign.description }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button onclick="switchTab('sent')" id="sent-tab" 
                        class="tab-button border-b-2 border-indigo-500 py-4 px-1 text-center text-sm font-medium text-indigo-600">
                    {% trans "Sent Emails" %} ({{ sent_emails.count }})
                </button>
                <button onclick="switchTab('pending')" id="pending-tab"
                        class="tab-button border-b-2 border-transparent py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    {% trans "Pending Emails" %} ({{ pending_emails.count }})
                </button>
            </nav>
        </div>
    </div>

    <!-- Sent Emails Tab -->
    <div id="sent-content" class="tab-content">
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">{% trans "Sent Emails" %}</h2>
            
            {% if sent_emails %}
                <div class="space-y-4">
                    {% for send_request in sent_emails %}
                        <div class="email-item border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">{{ send_request.email.subject }}</h3>
                                    <div class="mt-2 space-y-1">
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">{% trans "To:" %}</span> {{ send_request.subscriber_email }}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">{% trans "Sent:" %}</span> {{ send_request.sent_at|date:"M d, Y g:i A" }}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">{% trans "Status:" %}</span> 
                                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">{% trans "Sent" %}</span>
                                        </p>
                                    </div>
                                </div>
                                <button onclick="toggleEmailContent('sent-{{ send_request.id }}')" 
                                        class="ml-4 text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                                    <span>{% trans "View Details" %}</span>
                                    <svg class="w-5 h-5 ml-1 rotate-icon" id="icon-sent-{{ send_request.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Expanded Content -->
                            <div id="sent-{{ send_request.id }}" class="email-content-expanded mt-4">
                                <div class="border-t border-gray-300 pt-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <h4 class="font-semibold text-gray-700 mb-2">{% trans "Email Attributes" %}</h4>
                                            <dl class="space-y-1 text-sm">
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Email ID:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.email.id }}</dd>
                                                </div>
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Order:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.email.order }}</dd>
                                                </div>
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Wait Time:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.email.wait_time_display }}</dd>
                                                </div>
                                                {% if send_request.subscriber %}
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Subscriber:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.subscriber.name|default:send_request.subscriber.email }}</dd>
                                                </div>
                                                {% endif %}
                                            </dl>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-700 mb-2">{% trans "Sending Details" %}</h4>
                                            <dl class="space-y-1 text-sm">
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Scheduled:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.scheduled_for|date:"M d, Y g:i A" }}</dd>
                                                </div>
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Created:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.created_at|date:"M d, Y g:i A" }}</dd>
                                                </div>
                                            </dl>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h4 class="font-semibold text-gray-700 mb-2">{% trans "Email Content" %}</h4>
                                        <div class="bg-white border border-gray-300 rounded p-4 max-h-96 overflow-y-auto">
                                            {{ send_request.email.body_html|safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-600">{% trans "No emails have been sent from this campaign yet." %}</p>
            {% endif %}
        </div>
    </div>

    <!-- Pending Emails Tab -->
    <div id="pending-content" class="tab-content hidden">
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">{% trans "Pending Emails" %}</h2>
            
            {% if pending_emails %}
                <div class="space-y-4">
                    {% for send_request in pending_emails %}
                        <div class="email-item border border-gray-200 rounded-lg p-4 bg-gray-50" id="pending-item-{{ send_request.id }}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">{{ send_request.email.subject }}</h3>
                                    <div class="mt-2 space-y-1">
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">{% trans "To:" %}</span> {{ send_request.subscriber_email }}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">{% trans "Scheduled for:" %}</span> {{ send_request.scheduled_for|date:"M d, Y g:i A" }}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            <span class="font-medium">{% trans "Status:" %}</span> 
                                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">{{ send_request.get_status_display }}</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="ml-4 flex flex-col gap-2">
                                    <button onclick="toggleEmailContent('pending-{{ send_request.id }}')" 
                                            class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                                        <span>{% trans "View Details" %}</span>
                                        <svg class="w-5 h-5 ml-1 rotate-icon" id="icon-pending-{{ send_request.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <button onclick="sendPendingEmail('{{ send_request.id }}')" 
                                            id="send-btn-{{ send_request.id }}"
                                            class="send-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                        {% trans "Send Now" %}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Expanded Content -->
                            <div id="pending-{{ send_request.id }}" class="email-content-expanded mt-4">
                                <div class="border-t border-gray-300 pt-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <h4 class="font-semibold text-gray-700 mb-2">{% trans "Email Attributes" %}</h4>
                                            <dl class="space-y-1 text-sm">
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Email ID:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.email.id }}</dd>
                                                </div>
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Order:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.email.order }}</dd>
                                                </div>
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Wait Time:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.email.wait_time_display }}</dd>
                                                </div>
                                                {% if send_request.subscriber %}
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Subscriber:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.subscriber.name|default:send_request.subscriber.email }}</dd>
                                                </div>
                                                {% endif %}
                                            </dl>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-700 mb-2">{% trans "Sending Details" %}</h4>
                                            <dl class="space-y-1 text-sm">
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Created:" %}</dt>
                                                    <dd class="text-gray-800">{{ send_request.created_at|date:"M d, Y g:i A" }}</dd>
                                                </div>
                                                {% if send_request.variables %}
                                                <div class="flex">
                                                    <dt class="font-medium text-gray-600 w-32">{% trans "Variables:" %}</dt>
                                                    <dd class="text-gray-800 text-xs">{{ send_request.variables }}</dd>
                                                </div>
                                                {% endif %}
                                            </dl>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h4 class="font-semibold text-gray-700 mb-2">{% trans "Email Content" %}</h4>
                                        <div class="bg-white border border-gray-300 rounded p-4 max-h-96 overflow-y-auto">
                                            {{ send_request.email.body_html|safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-600">{% trans "No pending emails for this campaign." %}</p>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Tab switching
    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Remove active styling from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-indigo-500', 'text-indigo-600');
            button.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-content').classList.remove('hidden');
        
        // Add active styling to selected tab
        const selectedTab = document.getElementById(tabName + '-tab');
        selectedTab.classList.add('border-indigo-500', 'text-indigo-600');
        selectedTab.classList.remove('border-transparent', 'text-gray-500');
    }
    
    // Toggle email content expansion
    function toggleEmailContent(elementId) {
        const content = document.getElementById(elementId);
        const icon = document.getElementById('icon-' + elementId);
        
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    }
    
    // Send pending email
    async function sendPendingEmail(requestId) {
        const button = document.getElementById('send-btn-' + requestId);
        const originalText = button.textContent;
        
        // Disable button and show loading
        button.disabled = true;
        button.textContent = '{% trans "Sending..." %}';
        
        try {
            const response = await fetch(`/api/email-send-requests/${requestId}/send/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Show success message
                showNotification('{% trans "Email sent successfully!" %}', 'success');
                
                // Reload the page to refresh the lists
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                // Show error message
                showNotification(data.error || '{% trans "Failed to send email" %}', 'error');
                button.disabled = false;
                button.textContent = originalText;
            }
        } catch (error) {
            console.error('Error sending email:', error);
            showNotification('{% trans "An error occurred while sending the email" %}', 'error');
            button.disabled = false;
            button.textContent = originalText;
        }
    }
    
    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Show notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } text-white`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>
{% endblock %}

{% extends "base.html" %}
{% load i18n %}
{% load email_utils %}

{% block title %}{% trans "Edit Campaign" %} - {{ campaign.name }}{% endblock %}

{% block extra_css %}
<style>
    .email-details-expanded {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .email-details-expanded:not(.hidden) {
        max-height: 1000px;
        transition: max-height 0.5s ease-in;
    }
    .rotate-icon {
        transition: transform 0.3s ease;
    }
    .rotate-icon.rotated {
        transform: rotate(180deg);
    }
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">{{ campaign.name }}</h1>
            <div class="flex space-x-4">
                <button id="activateBtn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white {% if campaign.is_active %}bg-red-600 hover:bg-red-700{% else %}bg-green-600 hover:bg-green-700{% endif %}">
                    {% if campaign.is_active %}
                        {% trans "Deactivate" %}
                    {% else %}
                        {% trans "Activate" %}
                    {% endif %}
                </button>
                <a href="{% url 'campaigns:template' campaign.id %}" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    {% trans "Add Email" %}
                </a>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="p-6">
                <form id="campaignForm" class="space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">{% trans "Campaign Name" %}</label>
                        <input type="text" name="name" id="name" value="{{ campaign.name }}" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">{% trans "Description" %}</label>
                        <textarea name="description" id="description" rows="3"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{{ campaign.description }}</textarea>
                    </div>
                    
                    <div>
                        <label for="subscriber_list" class="block text-sm font-medium text-gray-700">{% trans "Subscriber List" %}</label>
                        <div class="mt-1 flex space-x-4">
                            <select name="subscriber_list" id="subscriber_list"
                                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">{% trans "Select a list or upload contacts" %}</option>
                                {% for list in lists %}
                                    <option value="{{ list.id }}" {% if list.id == campaign.subscriber_list.id %}selected{% endif %}>{{ list.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="uploadBtn"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                {% trans "Upload Contacts" %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">{% trans "Email Sequence" %}</h2>
                <a href="{% url 'campaigns:template' campaign.id %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    {% trans "Create New Email" %}
                </a>
            </div>
            <div class="space-y-4">
                {% for email in emails %}
                <div class="bg-white shadow rounded-lg overflow-hidden" data-email-id="{{ email.id }}" data-order="{{ email.order }}">
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start space-x-4">
                                <!-- Order Controls -->
                                <div class="flex flex-col space-y-1">
                                    <button type="button" class="move-up-btn text-gray-400 hover:text-gray-600 disabled:text-gray-200 disabled:cursor-not-allowed" 
                                            data-email-id="{{ email.id }}" {% if forloop.first %}disabled{% endif %}>
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                        </svg>
                                    </button>
                                    <button type="button" class="move-down-btn text-gray-400 hover:text-gray-600 disabled:text-gray-200 disabled:cursor-not-allowed" 
                                            data-email-id="{{ email.id }}" {% if forloop.last %}disabled{% endif %}>
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Email Info -->
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            {% trans "Step" %} {{ forloop.counter }}
                                        </span>
                                    </div>
                                    <h3 class="text-lg font-medium text-gray-900">{{ email.subject }}</h3>
                                    <p class="mt-1 text-sm text-gray-500">
                                        {% trans "Wait" %}: {{ email.wait_time_display }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex space-x-2">
                                <a href="{% url 'campaigns:template' campaign.id %}?template_id={{ email.id }}" 
                                   class="text-indigo-600 hover:text-indigo-900">
                                    {% trans "Edit" %}
                                </a>
                                <button type="button" class="text-red-600 hover:text-red-900 delete-email" 
                                        data-email-id="{{ email.id }}">
                                    {% trans "Delete" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-12 bg-white shadow rounded-lg">
                    <p class="text-gray-500">{% trans "No emails in this campaign yet." %}</p>
                    <a href="{% url 'campaigns:template' campaign.id %}" 
                       class="mt-4 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        {% trans "Add First Email" %}
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sent and Pending Emails Section -->
        <div class="mt-8">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchEmailTab('sent')" id="sent-email-tab" 
                            class="email-tab-button border-b-2 border-indigo-500 py-4 px-1 text-center text-sm font-medium text-indigo-600">
                        {% trans "Sent Emails" %} ({{ sent_emails.paginator.count }})
                    </button>
                    <button onclick="switchEmailTab('pending')" id="pending-email-tab"
                            class="email-tab-button border-b-2 border-transparent py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        {% trans "Pending Emails" %} ({{ pending_emails.paginator.count }})
                    </button>
                    <button onclick="switchEmailTab('imap-auto-reply')" id="imap-auto-reply-email-tab"
                            class="email-tab-button border-b-2 border-transparent py-4 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        {% trans "IMAP/Gmail Auto-Reply Emails" %} ({{ imap_auto_reply_emails.paginator.count }})
                    </button>
                </nav>
            </div>

            <!-- Sent Emails Tab -->
            <div id="sent-email-content" class="email-tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">{% trans "Sent Emails" %}</h3>
                    
                    {% if sent_emails %}
                        <div class="space-y-4">
                            {% for send_request in sent_emails %}
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold text-gray-900">{{ send_request.email.subject }}</h4>
                                            <div class="mt-2 space-y-1">
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "To:" %}</span> {{ send_request.subscriber_email }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "Sent:" %}</span> {{ send_request.sent_at|timezone_format:user_timezone }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "Status:" %}</span> 
                                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">{% trans "Sent" %}</span>
                                                </p>
                                            </div>
                                        </div>
                                        <button onclick="toggleEmailDetails('sent-{{ send_request.id }}')" 
                                                class="ml-4 text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                                            <span>{% trans "View Details" %}</span>
                                            <svg class="w-5 h-5 ml-1 rotate-icon" id="icon-sent-{{ send_request.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Expanded Content -->
                                    <div id="sent-{{ send_request.id }}" class="email-details-expanded mt-4 hidden">
                                        <div class="border-t border-gray-300 pt-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Attributes" %}</h5>
                                                    <dl class="space-y-1 text-sm">
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Email ID:" %}</dt>
                                                            <dd class="text-gray-800 text-xs">{{ send_request.email.id }}</dd>
                                                        </div>
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Order:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.email.order }}</dd>
                                                        </div>
                                                        {% if send_request.subscriber %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Subscriber:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.subscriber.first_name }} {{ send_request.subscriber.last_name }}</dd>
                                                        </div>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                                <div>
                                                    <h5 class="font-semibold text-gray-700 mb-2">{% trans "Sending Details" %}</h5>
                                                    <dl class="space-y-1 text-sm">
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Scheduled:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.scheduled_for|timezone_format:user_timezone }}</dd>
                                                        </div>
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Created:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.created_at|timezone_format:user_timezone }}</dd>
                                                        </div>
                                                    </dl>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Content" %}</h5>
                                                <div class="bg-white border border-gray-300 rounded p-4 max-h-96 overflow-y-auto">
                                                    {{ send_request.email.body_html|safe }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-600">{% trans "No emails have been sent from this campaign yet." %}</p>
                    {% endif %}
                    
                    <!-- Pagination for Sent Emails -->
                    {% if sent_emails.has_other_pages %}
                        <div class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
                            <div class="flex-1 flex justify-between sm:hidden">
                                {% if sent_emails.has_previous %}
                                    <a href="?sent_page={{ sent_emails.previous_page_number }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        {% trans "Previous" %}
                                    </a>
                                {% endif %}
                                {% if sent_emails.has_next %}
                                    <a href="?sent_page={{ sent_emails.next_page_number }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        {% trans "Next" %}
                                    </a>
                                {% endif %}
                            </div>
                            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-sm text-gray-700">
                                        {% trans "Showing" %} <span class="font-medium">{{ sent_emails.start_index }}</span> {% trans "to" %} <span class="font-medium">{{ sent_emails.end_index }}</span> {% trans "of" %} <span class="font-medium">{{ sent_emails.paginator.count }}</span> {% trans "results" %}
                                    </p>
                                </div>
                                <div>
                                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                        {% if sent_emails.has_previous %}
                                            <a href="?sent_page={{ sent_emails.previous_page_number }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                <span class="sr-only">{% trans "Previous" %}</span>
                                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                        {% for num in sent_emails.paginator.page_range %}
                                            {% if num == sent_emails.number %}
                                                <span class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">{{ num }}</span>
                                            {% elif num > sent_emails.number|add:'-3' and num < sent_emails.number|add:'3' %}
                                                <a href="?sent_page={{ num }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">{{ num }}</a>
                                            {% endif %}
                                        {% endfor %}
                                        {% if sent_emails.has_next %}
                                            <a href="?sent_page={{ sent_emails.next_page_number }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                <span class="sr-only">{% trans "Next" %}</span>
                                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                    </nav>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pending Emails Tab -->
            <div id="pending-email-content" class="email-tab-content hidden">
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">{% trans "Pending Emails" %}</h3>
                    
                    {% if pending_emails %}
                        <div class="space-y-4">
                            {% for send_request in pending_emails %}
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 hover:shadow-md transition-shadow" id="pending-item-{{ send_request.id }}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold text-gray-900">{{ send_request.email.subject }}</h4>
                                            <div class="mt-2 space-y-1">
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "To:" %}</span> {{ send_request.subscriber_email }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "Scheduled for:" %}</span> {{ send_request.scheduled_for|timezone_format:user_timezone }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "Status:" %}</span> 
                                                    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">{{ send_request.get_status_display }}</span>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="ml-4 flex flex-col gap-2">
                                            <button onclick="toggleEmailDetails('pending-{{ send_request.id }}')" 
                                                    class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                                                <span>{% trans "View Details" %}</span>
                                                <svg class="w-5 h-5 ml-1 rotate-icon" id="icon-pending-{{ send_request.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            <button onclick="sendPendingEmail('{{ send_request.id }}')" 
                                                    id="send-btn-{{ send_request.id }}"
                                                    class="send-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:shadow-md transition-all">
                                                {% trans "Send Now" %}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Expanded Content -->
                                    <div id="pending-{{ send_request.id }}" class="email-details-expanded mt-4 hidden">
                                        <div class="border-t border-gray-300 pt-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Attributes" %}</h5>
                                                    <dl class="space-y-1 text-sm">
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Email ID:" %}</dt>
                                                            <dd class="text-gray-800 text-xs">{{ send_request.email.id }}</dd>
                                                        </div>
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Order:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.email.order }}</dd>
                                                        </div>
                                                        {% if send_request.subscriber %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Subscriber:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.subscriber.first_name }} {{ send_request.subscriber.last_name }}</dd>
                                                        </div>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                                <div>
                                                    <h5 class="font-semibold text-gray-700 mb-2">{% trans "Sending Details" %}</h5>
                                                    <dl class="space-y-1 text-sm">
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Created:" %}</dt>
                                                            <dd class="text-gray-800">{{ send_request.created_at|timezone_format:user_timezone }}</dd>
                                                        </div>
                                                        {% if send_request.variables %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Variables:" %}</dt>
                                                            <dd class="text-gray-800 text-xs">{{ send_request.variables }}</dd>
                                                        </div>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Content" %}</h5>
                                                <div class="bg-white border border-gray-300 rounded p-4 max-h-96 overflow-y-auto">
                                                    {{ send_request.email.body_html|safe }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-600">{% trans "No pending emails for this campaign." %}</p>
                    {% endif %}
                    
                    <!-- Pagination for Pending Emails -->
                    {% if pending_emails.has_other_pages %}
                        <div class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
                            <div class="flex-1 flex justify-between sm:hidden">
                                {% if pending_emails.has_previous %}
                                    <a href="?pending_page={{ pending_emails.previous_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        {% trans "Previous" %}
                                    </a>
                                {% endif %}
                                {% if pending_emails.has_next %}
                                    <a href="?pending_page={{ pending_emails.next_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        {% trans "Next" %}
                                    </a>
                                {% endif %}
                            </div>
                            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-sm text-gray-700">
                                        {% trans "Showing" %} <span class="font-medium">{{ pending_emails.start_index }}</span> {% trans "to" %} <span class="font-medium">{{ pending_emails.end_index }}</span> {% trans "of" %} <span class="font-medium">{{ pending_emails.paginator.count }}</span> {% trans "results" %}
                                    </p>
                                </div>
                                <div>
                                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                        {% if pending_emails.has_previous %}
                                            <a href="?pending_page={{ pending_emails.previous_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                <span class="sr-only">{% trans "Previous" %}</span>
                                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                        {% for num in pending_emails.paginator.page_range %}
                                            {% if num == pending_emails.number %}
                                                <span class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">{{ num }}</span>
                                            {% elif num > pending_emails.number|add:'-3' and num < pending_emails.number|add:'3' %}
                                                <a href="?pending_page={{ num }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">{{ num }}</a>
                                            {% endif %}
                                        {% endfor %}
                                        {% if pending_emails.has_next %}
                                            <a href="?pending_page={{ pending_emails.next_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.imap_page %}&imap_page={{ request.GET.imap_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                <span class="sr-only">{% trans "Next" %}</span>
                                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                    </nav>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- IMAP/Gmail Auto-Reply Emails Tab -->
            <div id="imap-auto-reply-email-content" class="email-tab-content hidden">
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">{% trans "IMAP/Gmail Auto-Reply Emails" %}</h3>
                    
                    {% if imap_auto_reply_emails %}
                        <div class="space-y-4">
                            {% for email_msg in imap_auto_reply_emails %}
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="text-lg font-semibold text-gray-900">{{ email_msg.subject }}</h4>
                                            <div class="mt-2 space-y-1">
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "To:" %}</span> 
                                                    {% if email_msg.provider_data.recipient_email %}
                                                        {{ email_msg.provider_data.recipient_email }}
                                                    {% elif email_msg.to_emails %}
                                                        {{ email_msg.to_emails }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "From:" %}</span> {{ email_msg.from_email }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "Sent:" %}</span> {{ email_msg.received_at|timezone_format:user_timezone }}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-medium">{% trans "Status:" %}</span> 
                                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">{% trans "Sent" %}</span>
                                                </p>
                                            </div>
                                        </div>
                                        <button onclick="toggleEmailDetails('imap-auto-reply-{{ email_msg.id }}')" 
                                                class="ml-4 text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                                            <span>{% trans "View Details" %}</span>
                                            <svg class="w-5 h-5 ml-1 rotate-icon" id="icon-imap-auto-reply-{{ email_msg.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Expanded Content -->
                                    <div id="imap-auto-reply-{{ email_msg.id }}" class="email-details-expanded mt-4 hidden">
                                        <div class="border-t border-gray-300 pt-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Attributes" %}</h5>
                                                    <dl class="space-y-1 text-sm">
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Email ID:" %}</dt>
                                                            <dd class="text-gray-800 text-xs">{{ email_msg.id }}</dd>
                                                        </div>
                                                        {% if email_msg.campaign_email %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Campaign Email:" %}</dt>
                                                            <dd class="text-gray-800">{{ email_msg.campaign_email.subject }}</dd>
                                                        </div>
                                                        {% endif %}
                                                        {% if email_msg.credential %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "IMAP Account:" %}</dt>
                                                            <dd class="text-gray-800">{{ email_msg.credential.email_address }}</dd>
                                                        </div>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                                <div>
                                                    <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Details" %}</h5>
                                                    <dl class="space-y-1 text-sm">
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Received:" %}</dt>
                                                            <dd class="text-gray-800">{{ email_msg.received_at|timezone_format:user_timezone }}</dd>
                                                        </div>
                                                        {% if email_msg.provider_data.recipient_email %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Recipient:" %}</dt>
                                                            <dd class="text-gray-800">{{ email_msg.provider_data.recipient_email }}</dd>
                                                        </div>
                                                        {% endif %}
                                                        {% if email_msg.provider_data.recipient_name %}
                                                        <div class="flex">
                                                            <dt class="font-medium text-gray-600 w-32">{% trans "Recipient Name:" %}</dt>
                                                            <dd class="text-gray-800">{{ email_msg.provider_data.recipient_name }}</dd>
                                                        </div>
                                                        {% endif %}
                                                    </dl>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <h5 class="font-semibold text-gray-700 mb-2">{% trans "Email Content" %}</h5>
                                                <div class="bg-white border border-gray-300 rounded p-4 max-h-96 overflow-y-auto">
                                                    {% if email_msg.body_html %}
                                                        {{ email_msg.body_html|safe|truncatewords:100 }}
                                                    {% elif email_msg.body_text %}
                                                        <pre class="whitespace-pre-wrap text-sm">{{ email_msg.body_text|truncatewords:100 }}</pre>
                                                    {% else %}
                                                        <p class="text-gray-500 italic">{% trans "No content available" %}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-600">{% trans "No IMAP auto-reply emails have been sent from this campaign yet." %}</p>
                    {% endif %}
                    
                    <!-- Pagination for IMAP Auto-Reply Emails -->
                    {% if imap_auto_reply_emails.has_other_pages %}
                        <div class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
                            <div class="flex-1 flex justify-between sm:hidden">
                                {% if imap_auto_reply_emails.has_previous %}
                                    <a href="?imap_page={{ imap_auto_reply_emails.previous_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        {% trans "Previous" %}
                                    </a>
                                {% endif %}
                                {% if imap_auto_reply_emails.has_next %}
                                    <a href="?imap_page={{ imap_auto_reply_emails.next_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        {% trans "Next" %}
                                    </a>
                                {% endif %}
                            </div>
                            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-sm text-gray-700">
                                        {% trans "Showing" %} <span class="font-medium">{{ imap_auto_reply_emails.start_index }}</span> {% trans "to" %} <span class="font-medium">{{ imap_auto_reply_emails.end_index }}</span> {% trans "of" %} <span class="font-medium">{{ imap_auto_reply_emails.paginator.count }}</span> {% trans "results" %}
                                    </p>
                                </div>
                                <div>
                                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                        {% if imap_auto_reply_emails.has_previous %}
                                            <a href="?imap_page={{ imap_auto_reply_emails.previous_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                <span class="sr-only">{% trans "Previous" %}</span>
                                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                        {% for num in imap_auto_reply_emails.paginator.page_range %}
                                            {% if num == imap_auto_reply_emails.number %}
                                                <span class="relative inline-flex items-center px-4 py-2 border border-indigo-500 bg-indigo-50 text-sm font-medium text-indigo-600">{{ num }}</span>
                                            {% elif num > imap_auto_reply_emails.number|add:'-3' and num < imap_auto_reply_emails.number|add:'3' %}
                                                <a href="?imap_page={{ num }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">{{ num }}</a>
                                            {% endif %}
                                        {% endfor %}
                                        {% if imap_auto_reply_emails.has_next %}
                                            <a href="?imap_page={{ imap_auto_reply_emails.next_page_number }}{% if request.GET.sent_page %}&sent_page={{ request.GET.sent_page }}{% endif %}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                <span class="sr-only">{% trans "Next" %}</span>
                                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                    </nav>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal - uses same importer as /subscribers/import/ -->
<div id="uploadModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "Upload Contacts" %}</h3>
        <p class="text-sm text-gray-600 mb-4">{% trans "Contacts will be added to the subscriber list selected above. Use a file with columns like Email Address, First Name, Last Name, Company." %}</p>
        <div class="space-y-4">
            <div>
                <label for="contact_file" class="block text-sm font-medium text-gray-700">{% trans "Contact File" %}</label>
                <input type="file" id="contact_file" name="file" accept=".csv,.xls,.xlsx"
                       class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p class="mt-1 text-sm text-gray-500">{% trans "Supported formats: CSV, Excel (.xls, .xlsx). Columns are auto-matched (e.g. Email Address, First Name, Last Name)." %}</p>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancelUpload"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                {% trans "Cancel" %}
            </button>
            <button type="button" id="submitUpload"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                {% trans "Upload" %}
            </button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Show upload modal
    $('#uploadBtn').click(function() {
        $('#uploadModal').removeClass('hidden');
    });
    
    // Hide upload modal
    $('#cancelUpload').click(function() {
        $('#uploadModal').addClass('hidden');
        $('#contact_file').val('');
    });
    
    // Handle file upload - use same import API as /subscribers/import/
    $('#submitUpload').click(function() {
        const file = $('#contact_file')[0].files[0];
        const listId = $('#subscriber_list').val();
        
        if (!file) {
            alert('{% trans "Please select a file to upload" %}');
            return;
        }
        if (!listId) {
            alert('{% trans "Please select a subscriber list above first. Contacts will be added to that list." %}');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('list_id', listId);
        formData.append('mappings', '{}');
        
        $.ajax({
            url: '/api/subscribers/import/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                $('#uploadModal').addClass('hidden');
                $('#contact_file').val('');
                alert(response.message || '{% trans "Contacts imported successfully" %}');
            },
            error: function(xhr) {
                const msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '{% trans "An error occurred while uploading contacts" %}';
                alert(msg);
            }
        });
    });
    
    // Handle campaign form submission
    $('#campaignForm').submit(function(e) {
        e.preventDefault();
        
        const formData = {
            name: $('#name').val(),
            description: $('#description').val(),
            subscriber_list: $('#subscriber_list').val() || null
        };
        
        $.ajax({
            url: '/api/campaigns/{{ campaign.id }}/',
            type: 'PUT',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                window.location.reload();
            },
            error: function(xhr) {
                alert(xhr.responseJSON.error || '{% trans "An error occurred while updating the campaign" %}');
            }
        });
    });
    
    // Handle campaign activation/deactivation
    $('#activateBtn').click(function() {
        const action = $(this).text().trim().toLowerCase();
        const url = '/api/campaigns/{{ campaign.id }}/' + (action === 'activate' ? 'activate/' : 'deactivate/');
        
        $.ajax({
            url: url,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                window.location.reload();
            },
            error: function(xhr) {
                alert(xhr.responseJSON.error || '{% trans "An error occurred while updating the campaign status" %}');
            }
        });
    });
    
    // Handle email deletion
    $('.delete-email').click(function() {
        if (!confirm('{% trans "Are you sure you want to delete this email?" %}')) {
            return;
        }
        
        const emailId = $(this).data('email-id');
        
        $.ajax({
            url: '/api/campaigns/{{ campaign.id }}/emails/' + emailId + '/',
            type: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function() {
                window.location.reload();
            },
            error: function(xhr) {
                alert(xhr.responseJSON.error || '{% trans "An error occurred while deleting the email" %}');
            }
        });
    });
    
    // Handle email reordering
    $('.move-up-btn').click(function() {
        const emailId = $(this).data('email-id');
        reorderEmail(emailId, 'up');
    });
    
    $('.move-down-btn').click(function() {
        const emailId = $(this).data('email-id');
        reorderEmail(emailId, 'down');
    });
    
    function reorderEmail(emailId, direction) {
        $.ajax({
            url: '/api/campaigns/{{ campaign.id }}/emails/reorder/',
            type: 'POST',
            data: JSON.stringify({
                email_id: emailId,
                direction: direction
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                // Reload the page to show updated order
                window.location.reload();
            },
            error: function(xhr) {
                let errorMessage = '{% trans "An error occurred while reordering emails" %}';
                try {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                } catch (e) {
                    // Fallback to default message
                }
                alert(errorMessage);
            }
        });
    }
});

// Helper function to get CSRF token (global scope)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Tab switching for sent/pending emails
function switchEmailTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.email-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active styling from all tabs
    document.querySelectorAll('.email-tab-button').forEach(button => {
        button.classList.remove('border-indigo-500', 'text-indigo-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-email-content').classList.remove('hidden');
    
    // Add active styling to selected tab
    const selectedTab = document.getElementById(tabName + '-email-tab');
    selectedTab.classList.add('border-indigo-500', 'text-indigo-600');
    selectedTab.classList.remove('border-transparent', 'text-gray-500');
}

// Auto-switch tab based on URL parameters on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Check for pagination parameters and switch to corresponding tab
    if (urlParams.has('pending_page')) {
        switchEmailTab('pending');
    } else if (urlParams.has('imap_page')) {
        switchEmailTab('imap-auto-reply');
    } else if (urlParams.has('sent_page')) {
        switchEmailTab('sent');
    }
    // If no pagination parameter is present, default to 'sent' tab (which is already shown)
});

// Toggle email details expansion
function toggleEmailDetails(elementId) {
    const content = document.getElementById(elementId);
    const icon = document.getElementById('icon-' + elementId);
    
    content.classList.toggle('hidden');
    icon.classList.toggle('rotated');
}

// Send pending email
async function sendPendingEmail(requestId) {
    const button = document.getElementById('send-btn-' + requestId);
    const originalText = button.textContent;
    
    // Disable button and show loading
    button.disabled = true;
    button.textContent = '{% trans "Sending..." %}';
    
    try {
        const response = await fetch(`/api/email-send-requests/${requestId}/send/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Show success message
            showNotification('{% trans "Email sent successfully!" %}', 'success');
            
            // Reload the page to refresh the lists
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            // Show error message
            showNotification(data.error || '{% trans "Failed to send email" %}', 'error');
            button.disabled = false;
            button.textContent = originalText;
        }
    } catch (error) {
        console.error('Error sending email:', error);
        showNotification('{% trans "An error occurred while sending the email" %}', 'error');
        button.disabled = false;
        button.textContent = originalText;
    }
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
{% endblock %} 
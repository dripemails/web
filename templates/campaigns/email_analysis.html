{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Email Analysis" %} - DripEmails.org{% endblock %}

{% block extra_head %}
<script src="{% static 'chart.min.js' %}"></script>
<style>
    .topic-card {
        border-left: 4px solid #818cf8;
        transition: all 0.3s ease;
    }
    
    .topic-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .keyword-badge {
        display: inline-block;
        background: #f0f4ff;
        border: 1px solid #c7d2fe;
        color: #4f46e5;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        margin: 0.25rem;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #fee2e2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        display: none;
    }
    
    .error-message.show {
        display: block;
    }
    
    .success-message {
        background: #dcfce7;
        border: 1px solid #86efac;
        color: #15803d;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        display: none;
    }
    
    .success-message.show {
        display: block;
    }
    
    .results-container {
        display: none;
    }
    
    .results-container.show {
        display: block;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin: 2rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-8">
                <div class="bg-indigo-600 py-6 px-8 text-white">
                    <h1 class="text-2xl font-bold">{% trans "Email Topic Analysis" %}</h1>
                    <p class="text-indigo-100">{% trans "Analyze the topics in your campaign emails using AI-powered topic modeling" %}</p>
                </div>

                <!-- Controls -->
                <div class="p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="campaign_select" class="block text-sm font-medium text-gray-700 mb-2">
                                {% trans "Select Campaign" %}
                            </label>
                            <select id="campaign_select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">{% trans "Choose a campaign..." %}</option>
                                {% for campaign in campaigns %}
                                    <option value="{{ campaign.id }}" {% if campaign.id == selected_campaign_id %}selected{% endif %}>
                                        {{ campaign.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-2 text-sm text-gray-500">
                                {% trans "Select the campaign whose emails you want to analyze" %}
                            </p>
                        </div>

                        <div>
                            <label for="num_topics" class="block text-sm font-medium text-gray-700 mb-2">
                                {% trans "Number of Topics" %}
                            </label>
                            <div class="flex items-center space-x-4">
                                <input type="range" id="num_topics" min="2" max="10" value="5" 
                                       class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <span id="num_topics_display" class="text-lg font-medium text-indigo-600 w-8">5</span>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                {% trans "Adjust the number of topics to extract from the emails (2-10)" %}
                            </p>
                        </div>
                    </div>

                    <!-- Info Box -->
                    <div class="mt-6 bg-blue-50 border border-blue-200 p-4 rounded-lg">
                        <p class="text-sm text-blue-800">
                            ‚ÑπÔ∏è <strong>{% trans "How it works:" %}</strong>
                            {% trans "This analysis uses Latent Dirichlet Allocation (LDA), an advanced machine learning algorithm, to automatically discover the main topics discussed in your campaign emails. Results are based on word frequency patterns and co-occurrence." %}
                        </p>
                    </div>

                    <!-- Action Button -->
                    <div class="mt-6 flex justify-center">
                        <button id="analyze_btn" class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            üìä {% trans "Analyze Topics" %}
                        </button>
                    </div>

                    <!-- Messages -->
                    <div id="error_message" class="error-message"></div>
                    <div id="success_message" class="success-message"></div>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loading_spinner">
                        <div class="spinner"></div>
                        <p class="mt-4 text-gray-600">{% trans "Analyzing emails... This may take a moment." %}</p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results_container" class="results-container">
                <!-- Topic Overview -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">{% trans "Analysis Results" %}</h2>

                    <!-- Summary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-lg border border-indigo-100">
                            <p class="text-sm text-gray-600 mb-2">{% trans "Emails Analyzed" %}</p>
                            <p class="text-3xl font-bold text-indigo-600" id="email_count">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-lg border border-purple-100">
                            <p class="text-sm text-gray-600 mb-2">{% trans "Topics Discovered" %}</p>
                            <p class="text-3xl font-bold text-purple-600" id="topic_count">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-lg border border-green-100">
                            <p class="text-sm text-gray-600 mb-2">{% trans "Analysis Confidence" %}</p>
                            <p class="text-3xl font-bold text-green-600" id="confidence">‚Äî</p>
                        </div>
                    </div>

                    <!-- Topics List -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">{% trans "Discovered Topics" %}</h3>
                        <div id="topics_list" class="space-y-4">
                            <!-- Topics will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Email-Topic Distribution -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">{% trans "Email-Topic Relationship" %}</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        {% trans "Below shows the dominant topic for each email in your campaign:" %}
                    </p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {% trans "Email" %}
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {% trans "Dominant Topic" %}
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        {% trans "Confidence" %}
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="email_topics_table" class="bg-white divide-y divide-gray-200">
                                <!-- Email-topic pairs will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Topic Distribution Chart -->
                <div class="bg-white rounded-lg shadow-sm p-8">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">{% trans "Topic Distribution Across Emails" %}</h2>
                    <div class="chart-container">
                        <canvas id="topic_distribution_chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty_state" class="bg-white rounded-lg shadow-sm p-8 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900">{% trans "No analysis yet" %}</h3>
                <p class="mt-1 text-gray-500">{% trans "Select a campaign and click 'Analyze Topics' to get started" %}</p>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const campaignSelect = $('#campaign_select');
    const numTopicsSlider = $('#num_topics');
    const numTopicsDisplay = $('#num_topics_display');
    const analyzeBtn = $('#analyze_btn');
    const errorMsg = $('#error_message');
    const successMsg = $('#success_message');
    const loadingSpinner = $('#loading_spinner');
    const resultsContainer = $('#results_container');
    const emptyState = $('#empty_state');

    // Update slider display
    numTopicsSlider.on('input', function() {
        numTopicsDisplay.text($(this).val());
    });

    // Disable analyze button if no campaign is selected
    campaignSelect.on('change', function() {
        analyzeBtn.prop('disabled', !$(this).val());
    });

    // Analyze button click handler
    analyzeBtn.on('click', function() {
        const campaignId = campaignSelect.val();
        if (!campaignId) {
            showError('{% trans "Please select a campaign" %}');
            return;
        }

        analyzeTopics(campaignId);
    });

    function showError(message) {
        errorMsg.text(message).addClass('show');
        successMsg.removeClass('show');
    }

    function showSuccess(message) {
        successMsg.text(message).addClass('show');
        errorMsg.removeClass('show');
    }

    function hideMessages() {
        errorMsg.removeClass('show');
        successMsg.removeClass('show');
    }

    function analyzeTopics(campaignId) {
        analyzeBtn.prop('disabled', true);
        loadingSpinner.addClass('active');
        resultsContainer.removeClass('show');
        hideMessages();

        const data = {
            num_topics: parseInt(numTopicsSlider.val()),
            num_words: 5
        };

        $.ajax({
            type: 'POST',
            url: `/api/campaigns/${campaignId}/analyze-topics/`,
            data: JSON.stringify(data),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success) {
                    displayResults(response);
                    showSuccess('{% trans "Analysis completed successfully!" %}');
                    resultsContainer.addClass('show');
                    emptyState.hide();
                } else {
                    showError(response.error || '{% trans "Analysis failed" %}');
                }
            },
            error: function(xhr) {
                let errorText = '{% trans "An error occurred during analysis" %}';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorText = response.error || errorText;
                } catch (e) {}
                showError(errorText);
            },
            complete: function() {
                analyzeBtn.prop('disabled', false);
                loadingSpinner.removeClass('active');
            }
        });
    }

    function displayResults(response) {
        const topics = response.topics || [];
        const dominantTopics = response.dominant_topics || [];
        const emailCount = response.email_count || 0;

        // Update summary stats
        $('#email_count').text(emailCount);
        $('#topic_count').text(topics.length);
        $('#confidence').text('‚Äî');

        // Display topics
        const topicsList = $('#topics_list');
        topicsList.empty();

        topics.forEach((topic, index) => {
            const topicHtml = `
                <div class="topic-card bg-indigo-50 p-6 rounded-lg">
                    <div class="flex items-start justify-between mb-3">
                        <h4 class="text-lg font-semibold text-gray-900">{% trans "Topic" %} ${topic.topic_id + 1}</h4>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-200 text-indigo-800">
                            ${topic.top_word}
                        </span>
                    </div>
                    <div class="flex flex-wrap">
                        ${topic.keywords.map((keyword, idx) => `
                            <span class="keyword-badge" title="Weight: ${(topic.weights[idx] * 100).toFixed(2)}%">
                                ${keyword} <small>(${(topic.weights[idx] * 100).toFixed(1)}%)</small>
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
            topicsList.append(topicHtml);
        });

        // Display email-topic relationships
        displayEmailTopicTable(dominantTopics);

        // Create chart
        if (topics.length > 0) {
            createTopicChart(dominantTopics, topics.length);
        }
    }

    function displayEmailTopicTable(dominantTopics) {
        const tableBody = $('#email_topics_table');
        tableBody.empty();

        dominantTopics.forEach((topic, index) => {
            const confidence = (topic.confidence * 100).toFixed(1);
            const topicNum = topic.topic_id + 1;
            const row = `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {% trans "Email" %} ${index + 1}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                            {% trans "Topic" %} ${topicNum}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <div class="flex items-center">
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full" style="width: ${confidence}%"></div>
                            </div>
                            <span class="ml-2">${confidence}%</span>
                        </div>
                    </td>
                </tr>
            `;
            tableBody.append(row);
        });
    }

    let chartInstance = null;

    function createTopicChart(dominantTopics, numTopics) {
        const topicCounts = new Array(numTopics).fill(0);
        
        dominantTopics.forEach(topic => {
            if (topic.topic_id < numTopics) {
                topicCounts[topic.topic_id]++;
            }
        });

        const ctx = document.getElementById('topic_distribution_chart').getContext('2d');
        
        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: numTopics}, (_, i) => `{% trans "Topic" %} ${i + 1}`),
                datasets: [{
                    label: '{% trans "Number of Emails" %}',
                    data: topicCounts,
                    backgroundColor: [
                        '#818cf8',
                        '#f472b6',
                        '#34d399',
                        '#fbbf24',
                        '#60a5fa',
                        '#a78bfa',
                        '#fb7185',
                        '#4ade80',
                        '#f59e0b',
                        '#06b6d4'
                    ],
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load initial state
    if (!campaignSelect.val()) {
        analyzeBtn.prop('disabled', true);
    }
});
</script>
{% endblock %}

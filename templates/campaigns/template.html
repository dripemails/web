{% extends "base.html" %}
{% load i18n %}
{% load i18n static %}

{% block title %}{% trans "Email Template" %} - DripEmails.org{% endblock %}

{% block extra_head %}
<link href="{% static 'js/pell.css' %}" rel="stylesheet">
<script src="{% static 'js/pell.js' %}"></script>

<!-- include summernote library (jQuery) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- include summernote css/js -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote-lite.min.js"></script>

<style>
    .note-editable {
        min-height: 300px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
    }
    .note-editable p {
        margin: 0;
        padding: 0;
    }
    
    
    /* Ensure variables don't carry background styling when copied */
    .variable-code {
        background: transparent !important;
        color: #374151;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        padding: 0;
        border: none;
        border-radius: 0;
    }
    
    /* Override any inherited styles for copied content */
    .variable-code:focus,
    .variable-code:active,
    .variable-code:hover {
        background: transparent !important;
        color: #374151 !important;
    }
    
    /* Footer modal responsive sizing */
    #footerEditor .note-editable {
        min-height: 200px;
        max-height: calc(90vh - 300px);
        overflow-y: auto;
    }
    
    #footerEditor .note-editor {
        height: auto;
        min-height: 200px;
        max-height: calc(90vh - 300px);
    }
    
    /* Ensure modal is responsive on mobile */
    @media (max-width: 768px) {
        #newFooterModal .bg-white {
            margin: 1rem;
            max-width: calc(100vw - 2rem);
        }
        
        #footerEditor .note-editable {
            min-height: 150px;
            max-height: calc(90vh - 250px);
        }
        
        #footerEditor .note-editor {
            min-height: 150px;
            max-height: calc(90vh - 250px);
        }
    }

    {% if agent == 'mobile' %}
    /* Mobile-agent dropdown UX */
    select {
        min-height: 48px;
        font-size: 16px;
        line-height: 1.25rem;
        border-radius: 0.75rem;
        padding-left: 0.75rem;
        padding-right: 2.5rem;
        -webkit-appearance: none;
        appearance: none;
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.1rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    }
    {% endif %}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            {% if not campaign %}
            <!-- Campaign Selection Alert -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-yellow-700">
                            <strong>{% trans "No campaign selected." %}</strong> {% trans "You'll be prompted to select a campaign when you save this template." %}
                        </p>
                        <div class="mt-2">
                            <label for="campaign_selector" class="block text-sm font-medium text-yellow-900 mb-1">{% trans "Or select a campaign now:" %}</label>
                            <select id="campaign_selector" class="block w-full md:w-1/2 rounded-md border-yellow-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500">
                                <option value="">-- {% trans "Select a campaign (optional)" %} --</option>
                                {% for c in all_campaigns %}
                                    <option value="{{ c.id }}">{{ c.name }}{% if c.is_active %} ({% trans "Active" %}){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="bg-indigo-600 py-6 px-8 text-white">
                    <h1 class="text-2xl font-bold">{% trans "Email Template" %}</h1>
                    <p class="text-indigo-100">{% if campaign %}{{ campaign.name }}{% else %}{% trans "Design your email template" %}{% endif %}</p>
                </div>
                
                <form id="templateForm" class="p-8" method="POST" action="{% if template %}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/{% else %}/api/campaigns/{{ campaign.id }}/emails/{% endif %}">
                    {% csrf_token %}
                    <div class="space-y-6">
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700">{% trans "Email Subject" %}</label>
                            <input type="text" id="subject" name="subject" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label for="wait_time" class="block text-sm font-medium text-gray-700">{% trans "Wait Time" %}</label>
                            <div class="mt-1 flex space-x-3">
                                <input type="number" id="wait_time" name="wait_time" min="0" required
                                       class="block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <select id="wait_unit" name="wait_unit" required
                                        class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    {% for value, label in wait_units %}
                                        <option value="{{ value }}" {% if template and template.wait_unit == value %}selected{% elif not template and value == 'days' %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">
                                {% trans "Time to wait before sending this email after the previous one (0 = send immediately)" %}
                            </p>
                            
                            <!-- IMAP Auto-Reply Explanation - Only show for first email -->
                            {% if campaign and "IMAP" in campaign.name|upper and "AUTO-REPLY" in campaign.name|upper and is_first_email %}
                            <div id="imap-wait-time-info" class="mt-4 p-5 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 border-l-4 border-indigo-500 rounded-lg shadow-md">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-bold text-gray-900 mb-2 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                            </svg>
                                            {% trans "IMAP Auto-Reply Wait Time Explained" %}
                                        </h4>
                                        <div class="space-y-3 text-sm text-gray-700">
                                            <div class="bg-white/60 backdrop-blur-sm rounded-lg p-4 border border-indigo-200">
                                                <p class="font-semibold text-indigo-900 mb-2 flex items-center gap-2">
                                                    <svg class="w-4 h-4 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    {% trans "First Email (Order 1) - Should Be 0 Minutes" %}
                                                </p>
                                                <p class="leading-relaxed">
                                                    {% trans "For IMAP auto-reply campaigns, the first email in your sequence should have a wait time of 0 minutes. This ensures immediate responses to incoming emails, providing instant acknowledgment to your contacts and creating a professional, responsive experience." %}
                                                </p>
                                            </div>
                                            
                                            <!-- Collapsible content -->
                                            <div id="imap-explanation-expanded" class="hidden space-y-3">
                                                <div class="bg-white/60 backdrop-blur-sm rounded-lg p-4 border border-purple-200">
                                                    <p class="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                                                        <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                                                        </svg>
                                                        {% trans "How It Works" %}
                                                    </p>
                                                    <ul class="space-y-2 mt-2 ml-1">
                                                        <li class="flex items-start gap-2">
                                                            <span class="flex-shrink-0 w-5 h-5 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold mt-0.5">1</span>
                                                            <span>{% trans "When someone emails you, the system immediately sends your first email (0 minutes wait)" %}</span>
                                                        </li>
                                                        <li class="flex items-start gap-2">
                                                            <span class="flex-shrink-0 w-5 h-5 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center text-xs font-bold mt-0.5">2</span>
                                                            <span>{% trans "Subsequent emails in your sequence will use their own wait times (e.g., Email 2 waits 3 days, Email 3 waits 7 days)" %}</span>
                                                        </li>
                                                        <li class="flex items-start gap-2">
                                                            <span class="flex-shrink-0 w-5 h-5 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold mt-0.5">3</span>
                                                            <span>{% trans "Each wait time is calculated from when the previous email in the sequence was sent" %}</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="flex items-start gap-3 p-3 bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-lg">
                                                    <svg class="w-5 h-5 text-emerald-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    <div>
                                                        <p class="font-semibold text-emerald-900">{% trans "Pro Tip" %}</p>
                                                        <p class="text-emerald-800 text-sm mt-1">{% trans "Setting the first email to 0 minutes ensures your auto-replies are sent instantly when emails arrive, maintaining engagement and showing responsiveness to your contacts." %}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Read more/less toggle button -->
                                            <button type="button" id="imap-explanation-toggle" class="mt-3 flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors">
                                                <span>{% trans "Read more" %}</span>
                                                <svg id="imap-explanation-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-medium text-gray-900">{% trans "Email Content" %}</h2>
                                <div class="flex space-x-2">
                                    <button type="button" id="aiGenerateBtn" class="inline-flex items-center px-3 py-2 border border-green-300 shadow-sm text-sm leading-4 font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        ✨ {% trans "AI Generate" %}
                                    </button>
                                    <button type="button" id="previewBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Preview" %}
                                    </button>
                                    <button type="button" id="testBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Send Test" %}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">{% trans "Available Variables" %} <span class="text-xs text-gray-500">({% trans "Click to copy" %})</span></h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onmousedown="return copyVariable('{{first_name}}', this, event)" ontouchstart="return copyVariable('{{first_name}}', this, event)">
                                        <code class="variable-code">{{first_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onmousedown="return copyVariable('{{last_name}}', this, event)" ontouchstart="return copyVariable('{{last_name}}', this, event)">
                                        <code class="variable-code">{{last_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onmousedown="return copyVariable('{{full_name}}', this, event)" ontouchstart="return copyVariable('{{full_name}}', this, event)">
                                        <code class="variable-code">{{full_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onmousedown="return copyVariable('{{email}}', this, event)" ontouchstart="return copyVariable('{{email}}', this, event)">
                                        <code class="variable-code">{{email}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onmousedown="return copyVariable('{% templatetag openvariable %}sender_email{% templatetag closevariable %}', this, event)" ontouchstart="return copyVariable('{% templatetag openvariable %}sender_email{% templatetag closevariable %}', this, event)">
                                        <code class="variable-code">{% templatetag openvariable %}sender_email{% templatetag closevariable %}</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="body_html" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Email Content" %}</label>
                                <div id="editor" class="border border-gray-300 rounded-md"></div>
                                <textarea id="body_html" name="body_html" style="display: none;"></textarea>
                                
                            </div>
                            
                            <div class="mt-4">
                                <label for="footer_select" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Email Footer" %}</label>
                                <div class="flex space-x-2">
                                    <select id="footer_select" name="footer_id" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">{% trans "No footer" %}</option>
                                        {% for footer in user_footers %}
                                            <option value="{{ footer.id }}" {% if footer.is_default %}selected{% endif %}>{{ footer.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" id="newFooterBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        {% trans "New Footer" %}
                                    </button>
                                    <button type="button" id="editFooterBtn" class="px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {% trans "Edit Footer" %}
                                    </button>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    {% trans "Select a footer to append to your email, or leave empty for no footer." %}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-6 border-t border-gray-200 mb-6">
                            <button type="button" onclick="history.back()" class="text-gray-600 hover:text-gray-800">
                                {% trans "Cancel" %}
                            </button>
                            <div class="flex space-x-3">
                                <button type="button" id="sendEmailBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    {% trans "Send Email" %}
                                </button>
                                <button type="{% if show_campaign_modal %}button{% else %}submit{% endif %}" {% if show_campaign_modal %}onclick="showCampaignModal()"{% endif %} class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    {% trans "Save Template" %}
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h2 class="text-lg font-medium text-gray-900 mb-4">{% trans "API Integration" %}</h2>
                            
                            <!-- API Key Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-700">{% trans "Your API Key" %}</h3>
                                        <p class="text-sm text-gray-500 mt-1">{% trans "Use this key to authenticate your API requests" %}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="apiKey" value="{% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}{% trans 'No API key found. Please contact support.' %}{% endif %}" readonly
                                               class="block w-64 rounded-md border-gray-300 bg-gray-100 text-sm font-mono">
                                        <button type="button" onclick="copyApiKey()" 
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% trans "Copy" %}
                                        </button>
                                        <button type="button" onclick="regenerateApiKey()" 
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% trans "Regenerate" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {% if template %}
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <p class="text-sm text-gray-600">
                                    {% trans "Send emails using this template via API. Here's how to trigger this template programmatically:" %}
                                </p>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "Python" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>import requests

url = "{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/"
headers = {
    "Authorization": "Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}",
    "Content-Type": "application/json"
}
data = {
    "email": "subscriber@example.com",
    "variables": {
        "first_name": "John",
        "last_name": "Doe"
    }
}

response = requests.post(url, json=data, headers=headers)</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "JavaScript" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>fetch("{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/", {
    method: "POST",
    headers: {
        "Authorization": "Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}",
        "Content-Type": "application/json"
    },
    body: JSON.stringify({
        email: "subscriber@example.com",
        variables: {
            first_name: "John",
            last_name: "Doe"
        }
    })
})</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "Ruby" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>require 'net/http'
require 'json'

uri = URI("{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/")
headers = {
    'Authorization' => 'Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}',
    'Content-Type' => 'application/json'
}
data = {
    email: 'subscriber@example.com',
    variables: {
        first_name: 'John',
        last_name: 'Doe'
    }
}

http = Net::HTTP.new(uri.host, uri.port)
request = Net::HTTP::Post.new(uri.request_uri, headers)
request.body = data.to_json
response = http.request(request)</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "PHP" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>$url = "{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/";
$apiKey = "{% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}";

$data = [
    'email' => 'subscriber@example.com',
    'variables' => [
        'first_name' => 'John',
        'last_name' => 'Doe'
    ]
];

$ch = curl_init($url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Authorization: Bearer ' . $apiKey,
    'Content-Type: application/json'
]);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($httpCode === 200) {
    echo "Email sent successfully!";
} else {
    echo "Error: " . $response;
}</code></pre>
                                </div>
                            </div>
                            {% else %}
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                <p class="text-sm text-yellow-800">
                                    {% trans "Save your email template first to see the API code for sending emails." %}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center justify-between pt-6">
                            <button type="button" onclick="history.back()" class="text-gray-600 hover:text-gray-800">
                                {% trans "Cancel" %}
                            </button>
                            <div class="flex space-x-3">
                                <button type="button" id="sendEmailBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    {% trans "Send Email" %}
                                </button>
                                <button type="{% if show_campaign_modal %}button{% else %}submit{% endif %}" {% if show_campaign_modal %}onclick="showCampaignModal()"{% endif %} class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    {% trans "Save Template" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Campaign Selection Modal -->
    {% if show_campaign_modal %}
    <div id="campaignModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Select Campaign" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Choose which campaign to save this template to" %}</p>
            </div>
            <div class="p-6">
                <label for="modal_campaign_select" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Campaign" %}</label>
                <select id="modal_campaign_select" required
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="">-- {% trans "Select a campaign" %} --</option>
                    {% for c in all_campaigns %}
                        <option value="{{ c.id }}">{{ c.name }}{% if c.is_active %} ({% trans "Active" %}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                <button type="button" onclick="hideCampaignModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                    {% trans "Cancel" %}
                </button>
                <button type="button" onclick="submitWithCampaign()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {% trans "Save Template" %}
                </button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- AI Generate Modal -->
    <div id="aiModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">✨ {% trans "Generate Email with AI" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Describe what you want in your email and let AI create the content" %}</p>
            </div>
            <form id="aiGenerateForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="ai_subject_topic" class="block text-sm font-medium text-gray-700">{% trans "What is the email about?" %}</label>
                        <input type="text" id="ai_subject_topic" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                               placeholder="{% trans 'e.g., New product launch, special discount offer, welcome to our service...' %}">
                        <p class="mt-1 text-xs text-gray-500">{% trans "Describe the main topic or purpose of the email" %}</p>
                    </div>
                    
                    <div>
                        <label for="ai_context" class="block text-sm font-medium text-gray-700">{% trans "Email Details" %}</label>
                        <textarea id="ai_context" rows="4"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                  placeholder="Provide specific details:
- What action do you want readers to take?
- Any special offers or key information?
- Brand voice or personality to use?
- Call to action?"></textarea>
                        <p class="mt-1 text-xs text-gray-500">{% trans "Include any specific details, offers, key points, or instructions you want included" %}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="ai_recipient" class="block text-sm font-medium text-gray-700">{% trans "Who is this for?" %}</label>
                            <input type="text" id="ai_recipient"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                   placeholder="{% trans 'e.g., customers, subscribers, users...' %}" value="subscriber">
                        </div>
                        <div>
                            <label for="ai_tone" class="block text-sm font-medium text-gray-700">{% trans "Tone" %}</label>
                            <select id="ai_tone"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                <option value="professional">{% trans "Professional" %}</option>
                                <option value="friendly">{% trans "Friendly" %}</option>
                                <option value="persuasive">{% trans "Persuasive" %}</option>
                                <option value="casual">{% trans "Casual" %}</option>
                                <option value="formal">{% trans "Formal" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="ai_length" class="block text-sm font-medium text-gray-700">{% trans "Email Length" %}</label>
                        <select id="ai_length"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <option value="short">{% trans "Short (concise, 2-3 paragraphs)" %}</option>
                            <option value="medium" selected>{% trans "Medium (balanced, 4-5 paragraphs)" %}</option>
                            <option value="long">{% trans "Long (detailed, 6+ paragraphs)" %}</option>
                        </select>
                    </div>
                    
                    {% comment %}
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-md">
                        <p class="text-sm text-blue-800">
                            ℹ️ {% trans "AI generation uses Hugging Face API to create email content. The generated subject and body will replace your current email." %}
                        </p>
                    </div>
                    {% endcomment %}
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" id="cancelAiGenerate" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            ✨ {% trans "Generate Email" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Email Preview" %}</h3>
                <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">{% trans "Close" %}</span>
                    ×
                </button>
            </div>
            <div class="p-6">
                <div id="previewContent" class="prose max-w-none"></div>
            </div>
        </div>
    </div>
    
    <!-- Test Email Modal -->
    <div id="testModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Send Test Email" %}</h3>
            </div>
            <form id="testForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="test_email" class="block text-sm font-medium text-gray-700">{% trans "Email Address" %}</label>
                        <input type="email" id="test_email" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="test_first_name" class="block text-sm font-medium text-gray-700">{% trans "First Name" %}</label>
                        <input type="text" id="test_first_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter first name...' %}">
                    </div>
                    <div>
                        <label for="test_last_name" class="block text-sm font-medium text-gray-700">{% trans "Last Name" %}</label>
                        <input type="text" id="test_last_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter last name...' %}">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeTestModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            {% trans "Send" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Send Email Modal -->
    <div id="sendEmailModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Send Email" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Send this email template to a recipient" %}</p>
            </div>
            <form id="sendEmailForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="send_email" class="block text-sm font-medium text-gray-700">{% trans "Recipient Email" %}</label>
                        <input type="email" id="send_email" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                               placeholder="{% trans 'recipient@example.com' %}">
                    </div>
                    <div>
                        <label for="send_first_name" class="block text-sm font-medium text-gray-700">{% trans "First Name" %}</label>
                        <input type="text" id="send_first_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                               placeholder="{% trans 'Enter first name...' %}">
                    </div>
                    <div>
                        <label for="send_last_name" class="block text-sm font-medium text-gray-700">{% trans "Last Name" %}</label>
                        <input type="text" id="send_last_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                               placeholder="{% trans 'Enter last name...' %}">
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                        <p class="text-xs text-blue-800">
                            <strong>{% trans "Note:" %}</strong> {% trans "The email will be sent immediately. The recipient will be automatically added to this campaign's subscriber list." %}
                        </p>
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" id="cancelSendEmail" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            {% trans "Send Email" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Footer Modal -->
    <div id="newFooterModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Create New Footer" %}</h3>
            </div>
            <form id="newFooterForm" class="px-6 py-4 flex-1 flex flex-col overflow-hidden">
                <div class="space-y-4 flex-1 flex flex-col">
                    <div class="flex-shrink-0">
                        <label for="footerName" class="block text-sm font-medium text-gray-700 mb-1">
                            {% trans "Footer Name" %}
                        </label>
                        <input type="text" id="footerName" name="name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter footer name...' %}">
                    </div>
                    <div class="flex-1 flex flex-col min-h-0">
                        <label for="footerContent" class="block text-sm font-medium text-gray-700 mb-1 flex-shrink-0">
                            {% trans "Footer Content (HTML)" %}
                        </label>
                        <div class="flex-1 min-h-0">
                            <div id="footerEditor" class="border border-gray-300 rounded-md h-full"></div>
                        </div>
                        <textarea id="footerContent" name="html_content" style="display: none;"></textarea>
                        <p class="mt-1 text-sm text-gray-500 flex-shrink-0">
                            {% trans "Enter the HTML content for your footer. You can use variables like {{first_name}}, {{last_name}}, {{email}}, etc." %}
                        </p>
                    </div>
                    <div class="flex items-center flex-shrink-0">
                        <input type="checkbox" id="isDefault" name="is_default" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="isDefault" class="ml-2 block text-sm text-gray-900">
                            {% trans "Set as default footer" %}
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6 flex-shrink-0 border-t border-gray-200 pt-4">
                    <button type="button" id="cancelNewFooter" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        {% trans "Create Footer" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// @ts-nocheck - Django template variables used throughout
// Global variables for Summernote editors
let summernoteEditor;
let summernoteFooterEditor;
let hasSavedEditorRange = false;

function saveEditorRange() {
    if (!summernoteEditor) return;
    summernoteEditor.summernote('editor.saveRange');
    hasSavedEditorRange = true;
}

function restoreEditorRange() {
    if (!summernoteEditor || !hasSavedEditorRange) return;
    summernoteEditor.summernote('editor.restoreRange');
}

// Pass-through cleaner for editor HTML.
function cleanEditorContent(html) {
    if (!html) return html;
    return html;
}

function setSummernoteHtml(editor, html) {
    if (!editor) return;
    const cleaned = html ? cleanEditorContent(html) : '';
    editor.summernote('code', cleaned);
}

function getSummernoteHtml(editor) {
    if (!editor) return '';
    return editor.summernote('code') || '';
}

function getSummernoteText(editor) {
    if (!editor) return '';
    const text = editor.summernote('codeview.isActivated')
        ? editor.val()
        : editor.summernote('code');
    return $('<div>').html(text || '').text().trim();
}

function clearSummernote(editor) {
    if (!editor) return;
    editor.summernote('reset');
}

// Convert a plain-text body (body_text) into simple HTML paragraphs.
// This is used when an older email/template only has body_text and body_html is empty.
function bodyTextToHtml(text) {
    if (!text) return '';
    // Basic HTML escaping
    let escaped = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;/');
    const lines = escaped.split(/\r?\n/);
    // Map each line to a <p>...</p>; empty lines become <p><br></p> for visual spacing
    return lines.map(function(line) {
        if (!line.trim()) {
            return '<p><br></p>';
        }
        return '<p>' + line + '</p>';
    }).join('');
}

// Prepare HTML for saving/sending from Summernote.
// Keep spacing/paragraphs exactly as authored.
function prepareHtmlForSaving(html) {
    if (!html) return html;
    return cleanEditorContent(html);
}

// Function to copy variable to clipboard and insert into editor
function copyVariable(variable, element, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // Insert into Summernote editor at current cursor position
    if (summernoteEditor) {
        summernoteEditor.summernote('focus');
        restoreEditorRange();
        summernoteEditor.summernote('editor.insertText', variable);
        saveEditorRange();
    }

    // Best-effort copy to clipboard (do not block insertion on clipboard permission issues)
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(variable).catch(function(err) {
            console.warn('Could not copy text to clipboard:', err);
        });
    }

    // Show brief success feedback
    if (element) {
        const originalBg = element.style.backgroundColor;
        element.style.backgroundColor = '#10B981';
        setTimeout(() => {
            element.style.backgroundColor = originalBg;
        }, 200);
    }

    return false;
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Summernote editor
    summernoteEditor = $('#editor');
    summernoteEditor.summernote({
        height: 320,
        placeholder: '{% trans "Enter your email content here..." %}',
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['insert', ['link', 'picture']],
            ['view', ['codeview']]
        ],
        callbacks: {
            onInit: function() {
                saveEditorRange();
            },
            onFocus: function() {
                saveEditorRange();
            },
            onKeyup: function() {
                saveEditorRange();
            },
            onMouseup: function() {
                saveEditorRange();
            },
            onPaste: function() {
                saveEditorRange();
            }
        }
    });
    
    // Campaign modal functions
    const showCampaignModal = "{{ show_campaign_modal|default:False|lower }}" === "true";
    
    // Handle campaign selector at top of page
    const campaignSelector = document.getElementById('campaign_selector');
    if (campaignSelector && showCampaignModal) {
        campaignSelector.addEventListener('change', function() {
            if (this.value) {
                // Redirect to template page with selected campaign
                window.location.href = `/campaigns/template/${this.value}/{% if agent %}?agent={{ agent }}{% endif %}`;
            }
        });
    }
    
    if (showCampaignModal) {
        window.showCampaignModal = function() {
        // Check if user selected a campaign from the top selector
        const topCampaignSelector = document.getElementById('campaign_selector');
        if (topCampaignSelector && topCampaignSelector.value) {
            // Use the selected campaign from top selector
            submitWithSpecificCampaign(topCampaignSelector.value);
            return;
        }

        // Otherwise show modal for selection
        // Validate form first
        const subject = document.getElementById('subject').value.trim();
        const bodyContent = cleanEditorContent(getSummernoteHtml(summernoteEditor).trim());
        
        if (!subject) {
            alert('{% trans "Please enter an email subject." %}');
            return;
        }
        
        if (!bodyContent || bodyContent === '<p><br></p>') {
            alert('{% trans "Please enter email content." %}');
            return;
        }
        
        document.getElementById('campaignModal').classList.remove('hidden');
    };
    
    window.hideCampaignModal = function() {
        document.getElementById('campaignModal').classList.add('hidden');
    };
    
    window.submitWithCampaign = function() {
        const selectedCampaignId = document.getElementById('modal_campaign_select').value;
        
        if (!selectedCampaignId) {
            alert('{% trans "Please select a campaign." %}');
            return;
        }
        
        submitWithSpecificCampaign(selectedCampaignId);
    };
    
    window.submitWithSpecificCampaign = function(selectedCampaignId) {
        // Close modal if open
        const modal = document.getElementById('campaignModal');
        if (modal && !modal.classList.contains('hidden')) {
            hideCampaignModal();
        }
        hideCampaignModal();
        
        // Get form data
        // Use editor HTML exactly as authored in Summernote
        const rawHtml = getSummernoteHtml(summernoteEditor);
        const htmlContent = prepareHtmlForSaving(rawHtml);
        const footerSelect = document.getElementById('footer_select');
        const selectedFooterId = footerSelect.value;
        
        // Get wait_time value and ensure it's a valid integer
        const waitTimeInput = document.getElementById('wait_time');
        const waitUnitSelect = document.getElementById('wait_unit');
        const waitTimeValue = waitTimeInput.value.trim();
        const waitTime = waitTimeValue ? parseInt(waitTimeValue, 10) : 0;
        
        // Validate wait_time (0 is allowed for immediate sending)
        if (isNaN(waitTime) || waitTime < 0) {
            alert('{% trans "Wait time must be a number greater than or equal to 0 (0 = send immediately)." %}');
            return;
        }
        
        // Get wait_unit value even if disabled
        const waitUnit = waitUnitSelect.value || 'minutes';
        
        const data = {
            subject: document.getElementById('subject').value,
            wait_time: waitTime,
            wait_unit: waitUnit,
            body_html: htmlContent,
            body_text: getSummernoteText(summernoteEditor)
        };
        
        // Only add footer_id if a footer is selected
        if (selectedFooterId && selectedFooterId.trim()) {
            data.footer_id = selectedFooterId;
        }
        
        // Submit via API
        fetch(`/api/campaigns/${selectedCampaignId}/emails/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Validation failed');
                });
            }
            return response.json();
        })
        .then(data => {
            alert('{% trans "Template saved successfully!" %}');
            // Redirect to the campaign template page
            window.location.href = `/campaigns/template/${selectedCampaignId}/{% if agent %}?agent={{ agent }}{% endif %}`;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "An error occurred while saving the template: " %}' + error.message);
        });
    };
    
        // Close modal when clicking outside
        document.getElementById('campaignModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCampaignModal();
            }
        });
    }
    
    // Initialize footer editor
    summernoteFooterEditor = $('#footerEditor');
    summernoteFooterEditor.summernote({
        height: 220,
        placeholder: '{% trans "Enter footer content here..." %}',
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['insert', ['link']],
            ['view', ['codeview']]
        ]
    });
    
    const aiGenerateBtn = document.getElementById('aiGenerateBtn');
    const aiModal = document.getElementById('aiModal');
    const aiGenerateForm = document.getElementById('aiGenerateForm');
    const cancelAiGenerate = document.getElementById('cancelAiGenerate');
    
    const previewBtn = document.getElementById('previewBtn');
    const testBtn = document.getElementById('testBtn');
    const previewModal = document.getElementById('previewModal');
    const testModal = document.getElementById('testModal');
    const templateForm = document.getElementById('templateForm');
    const testForm = document.getElementById('testForm');
    const campaignId = '{{ campaign.id }}';
    const templateId = '{{ template.id|default:"" }}';
    const campaignName = '{{ campaign.name|default:"" }}';
    
    // Check if this is an IMAP Auto-Reply campaign
    const isImapAutoReply = campaignName && (campaignName.toUpperCase().includes('IMAP') && campaignName.toUpperCase().includes('AUTO-REPLY'));
    
    // Debug: Log campaignId and templateId
    console.log('campaignId:', campaignId);
    console.log('templateId:', templateId);
    console.log('isImapAutoReply:', isImapAutoReply);
    // Footer modal elements
    const newFooterBtn = document.getElementById('newFooterBtn');
    const editFooterBtn = document.getElementById('editFooterBtn');
    const newFooterModal = document.getElementById('newFooterModal');
    const cancelNewFooter = document.getElementById('cancelNewFooter');
    const newFooterForm = document.getElementById('newFooterForm');
    
    // Enable/disable \"Edit Footer\" based on selection and open analytics edit page when clicked
    const footerSelect = document.getElementById('footer_select');
    if (footerSelect && editFooterBtn) {
        const agent = '{{ agent|default_if_none:""|escapejs }}';
        
        function updateEditFooterState() {
            const val = footerSelect.value;
            const hasFooter = !!(val && val.trim());
            editFooterBtn.disabled = !hasFooter;
        }
        
        updateEditFooterState();
        footerSelect.addEventListener('change', updateEditFooterState);
        
        editFooterBtn.addEventListener('click', function() {
            const val = footerSelect.value;
            if (!val || !val.trim()) {
                alert('{% trans "Please select a footer to edit." %}');
                return;
            }
            // Use Django's URL reversing so language prefixes and URL structure are correct.
            // We generate the URL for footer_id=0 and replace the \"0\" with the selected ID.
            let url = "{% url 'analytics:footer_edit' 0 %}";
            url = url.replace('/0/', `/${val}/`);
            if (agent) {
                const sep = url.includes('?') ? '&' : '?';
                url += `${sep}agent=${agent}`;
            }
            // Open in a new tab so the template editor stays open
            window.open(url, '_blank');
        });
    }
    
    // Load template data if editing
    if (templateId) {
        fetch(`/api/campaigns/${campaignId}/emails/${templateId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('subject').value = data.subject;
                const waitTimeInput = document.getElementById('wait_time');
                const waitUnitSelect = document.getElementById('wait_unit');
                waitTimeInput.value = data.wait_time;
                waitUnitSelect.value = data.wait_unit;
                
                // Check if this is the first email (order 0 or 1)
                const isFirstEmail = data.order === 0 || data.order === 1;
                
                // If wait_time is 0 and this is the first email in an IMAP auto-reply campaign, disable the inputs
                if (data.wait_time === 0 && isImapAutoReply && isFirstEmail) {
                    waitTimeInput.disabled = true;
                    waitUnitSelect.disabled = true;
                    waitTimeInput.setAttribute('disabled', 'disabled');
                    waitUnitSelect.setAttribute('disabled', 'disabled');
                }
                
                // If this is NOT the first email, hide the explanation box
                if (!isFirstEmail) {
                    const imapExplanationBox = document.getElementById('imap-wait-time-info');
                    if (imapExplanationBox) {
                        imapExplanationBox.style.display = 'none';
                    }
                }
                
                // Set content in editor:
                // - Prefer HTML body when available
                // - Fallback to body_text (converted to simple HTML) when body_html is empty
                let htmlToLoad = data.body_html;
                if ((!htmlToLoad || htmlToLoad.trim() === '') && data.body_text) {
                    htmlToLoad = bodyTextToHtml(data.body_text);
                }
                setSummernoteHtml(summernoteEditor, htmlToLoad);
                
                // Set footer if available
                if (data.footer_id) {
                    document.getElementById('footer_select').value = data.footer_id;
                }
            })
            .catch(error => {
                console.error('Error loading template:', error);
                alert('{% trans "An error occurred while loading the template. Please try again." %}');
            });
    } else if (isImapAutoReply && campaignId) {
        // For new emails in IMAP Auto-Reply campaigns, check if this will be the first email
        // If campaign has no emails yet, or we're creating the first one, default wait_time to 0
        fetch(`/api/campaigns/${campaignId}/emails/`)
            .then(response => response.json())
            .then(data => {
                const emails = Array.isArray(data) ? data : [];
                // Get the minimum order from existing emails
                const minOrder = emails.length > 0 ? Math.min(...emails.map(e => e.order || 0)) : null;
                
                // Check if this will be the first email (order 0 or 1)
                const willBeFirstEmail = emails.length === 0 || minOrder >= 1;
                
                // If no emails exist, or if this will be the first email (order 0 or 1), automatically set wait_time to 0
                if (willBeFirstEmail) {
                    // This will be the first email, automatically set wait_time to 0 and disable the field
                    const waitTimeInput = document.getElementById('wait_time');
                    const waitUnitSelect = document.getElementById('wait_unit');
                    waitTimeInput.value = '0';
                    waitUnitSelect.value = 'minutes';
                    waitTimeInput.disabled = true;
                    waitUnitSelect.disabled = true;
                    waitTimeInput.setAttribute('disabled', 'disabled');
                    waitUnitSelect.setAttribute('disabled', 'disabled');
                    console.log('Auto-set wait_time to 0 and disabled input for IMAP Auto-Reply first email');
                } else {
                    // This is NOT the first email, hide the explanation box if it exists
                    const imapExplanationBox = document.getElementById('imap-wait-time-info');
                    if (imapExplanationBox) {
                        imapExplanationBox.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking campaign emails:', error);
                // If error, still set to 0 as safe default for IMAP campaigns and disable
                const waitTimeInput = document.getElementById('wait_time');
                const waitUnitSelect = document.getElementById('wait_unit');
                if (waitTimeInput && !waitTimeInput.value) {
                    waitTimeInput.value = '0';
                    waitUnitSelect.value = 'minutes';
                    waitTimeInput.disabled = true;
                    waitUnitSelect.disabled = true;
                    waitTimeInput.setAttribute('disabled', 'disabled');
                    waitUnitSelect.setAttribute('disabled', 'disabled');
                }
            });
    }
    
    // Toggle IMAP explanation expand/collapse
    const imapExplanationToggle = document.getElementById('imap-explanation-toggle');
    const imapExplanationExpanded = document.getElementById('imap-explanation-expanded');
    const imapExplanationArrow = document.getElementById('imap-explanation-arrow');
    
    if (imapExplanationToggle && imapExplanationExpanded) {
        imapExplanationToggle.addEventListener('click', function() {
            const isExpanded = !imapExplanationExpanded.classList.contains('hidden');
            if (isExpanded) {
                // Collapse
                imapExplanationExpanded.classList.add('hidden');
                imapExplanationToggle.querySelector('span').textContent = '{% trans "Read more" %}';
                if (imapExplanationArrow) {
                    imapExplanationArrow.style.transform = 'rotate(0deg)';
                }
            } else {
                // Expand
                imapExplanationExpanded.classList.remove('hidden');
                imapExplanationToggle.querySelector('span').textContent = '{% trans "Read less" %}';
                if (imapExplanationArrow) {
                    imapExplanationArrow.style.transform = 'rotate(180deg)';
                }
            }
        });
    }
    
    // AI Generate functionality - Show modal for user input
    if (aiGenerateBtn) {
        aiGenerateBtn.addEventListener('click', function() {
            // Check if campaignId is empty
            if (!campaignId || campaignId.trim() === '') {
                alert('{% trans "Error: Campaign ID is missing. Please select a campaign first." %}');
                return;
            }
            
            // Show the modal instead of auto-generating
            aiModal.classList.remove('hidden');
            document.getElementById('ai_subject_topic').focus();
        });
    }
    
    // Keep cancel functionality for modal in case it's still needed elsewhere
    if (cancelAiGenerate) {
        cancelAiGenerate.addEventListener('click', function() {
            aiModal.classList.add('hidden');
            aiGenerateForm.reset();
        });
    }
    
    if (aiModal) {
        aiModal.addEventListener('click', function(e) {
            if (e.target === aiModal) {
                aiModal.classList.add('hidden');
                aiGenerateForm.reset();
            }
        });
    }
    
    // Form submission for modal (in case user opens it manually)
    if (aiGenerateForm) {
        aiGenerateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const topic = document.getElementById('ai_subject_topic').value;
            const recipient = document.getElementById('ai_recipient').value;
            const tone = document.getElementById('ai_tone').value;
            const length = document.getElementById('ai_length').value;
            const context = document.getElementById('ai_context').value;
            
            const submitBtn = aiGenerateForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '✨ {% trans "Generating..." %}';
            submitBtn.disabled = true;
            
            const data = {
                subject_topic: topic,
                recipient: recipient,
                tone: tone,
                length: length,
                context: context,
                email_id: templateId || null
            };
            
            // Create AbortController for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutes timeout
            
            fetch(`/api/campaigns/${campaignId}/generate-email/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    // Try to get error details from response
                    return response.text().then(text => {
                        let errorData = null;
                        try {
                            errorData = JSON.parse(text);
                        } catch (e) {
                            // Response is not JSON
                            throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
                        }
                        const errorMsg = errorData.error || errorData.detail || errorData.message || 'Failed to generate email';
                        throw new Error(errorMsg);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.subject) {
                    document.getElementById('subject').value = data.subject;
                    setSummernoteHtml(summernoteEditor, data.body_html);
                    aiModal.classList.add('hidden');
                    aiGenerateForm.reset();
                    alert('{% trans "Email generated successfully! Review and save when ready." %}');
                } else {
                    alert('{% trans "Error: Invalid response from AI service." %}');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('AI Generation Error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                
                let errorMsg = '{% trans "Failed to generate email. " %}';
                
                // Handle different error types
                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    errorMsg += '{% trans "Request timed out after 5 minutes. The AI generation is taking too long. Please try again or check server resources." %}';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += '{% trans "Network error: Could not connect to server. Please check your connection and try again." %}';
                } else if (error.message.includes('Ollama')) {
                    errorMsg += error.message;
                } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                    errorMsg += '{% trans "Request timed out. The AI generation is taking too long. Please try again." %}';
                } else if (error.message.includes('500') || error.message.includes('server error')) {
                    errorMsg += error.message + ' {% trans "Please check the server logs for more details." %}';
                } else if (error.message.includes('404') || error.message.includes('not found')) {
                    errorMsg += error.message + ' {% trans "Please ensure Ollama is running on the server." %}';
                } else {
                    // Show the actual error message
                    errorMsg += error.message || '{% trans "Unknown error occurred. Please check the browser console and server logs for details." %}';
                }
                
                alert(errorMsg);
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Preview functionality
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            let content = cleanEditorContent(getSummernoteHtml(summernoteEditor));
            
            // Replace sender_email variable with user's email for preview
            const userEmail = '{{ request.user.email }}';
            // Handle both literal and HTML-encoded versions
            content = content.replaceAll('{{sender_email}}', userEmail);
            content = content.replaceAll('{{ sender_email }}', userEmail);
            content = content.replaceAll('&#123;&#123;sender_email&#125;&#125;', userEmail);
            content = content.replaceAll('{<!-- -->{sender_email}<!-- -->}', userEmail);
            
            // Get selected footer content
            const footerSelect = document.getElementById('footer_select');
            const selectedFooterId = footerSelect.value;
            let footerContent = '';
            
            if (selectedFooterId) {
                // Find the footer content from the options
                const footerOption = footerSelect.querySelector(`option[value="${selectedFooterId}"]`);
                if (footerOption) {
                    // This is a simplified approach - in a real implementation, you'd fetch the footer content
                    footerContent = '<hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;"><div style="font-size: 12px; color: #6b7280;">{% trans "[Footer content would appear here]" %}</div>';
                }
            }
            
            document.getElementById('previewContent').innerHTML = content + footerContent;
            previewModal.classList.remove('hidden');
        });
    }
    
    // Test email functionality
    if (testBtn) {
        testBtn.addEventListener('click', function() {
            testModal.classList.remove('hidden');
        });
    }
    
    // Footer modal functionality
    if (newFooterBtn) {
        newFooterBtn.addEventListener('click', function() {
            newFooterModal.classList.remove('hidden');
            document.getElementById('footerName').focus();
        });
    }
    
    if (cancelNewFooter) {
        cancelNewFooter.addEventListener('click', function() {
            newFooterModal.classList.add('hidden');
            newFooterForm.reset();
            clearSummernote(summernoteFooterEditor);
        });
    }
    
    // Close footer modal when clicking outside
    if (newFooterModal) {
        newFooterModal.addEventListener('click', function(e) {
            if (e.target === newFooterModal) {
                newFooterModal.classList.add('hidden');
                newFooterForm.reset();
                clearSummernote(summernoteFooterEditor);
            }
        });
    }
    
    // Send Email modal functionality
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const sendEmailModal = document.getElementById('sendEmailModal');
    const sendEmailForm = document.getElementById('sendEmailForm');
    const cancelSendEmail = document.getElementById('cancelSendEmail');
    
    if (sendEmailBtn) {
        sendEmailBtn.addEventListener('click', function() {
            sendEmailModal.classList.remove('hidden');
            document.getElementById('send_email').focus();
        });
    }
    
    if (cancelSendEmail) {
        cancelSendEmail.addEventListener('click', function() {
            sendEmailModal.classList.add('hidden');
            sendEmailForm.reset();
        });
    }
    
    // Close send email modal when clicking outside
    if (sendEmailModal) {
        sendEmailModal.addEventListener('click', function(e) {
            if (e.target === sendEmailModal) {
                sendEmailModal.classList.add('hidden');
                sendEmailForm.reset();
            }
        });
    }
    
    // Send Email form submission
    if (sendEmailForm) {
        sendEmailForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('send_email').value;
            const firstName = document.getElementById('send_first_name').value;
            const lastName = document.getElementById('send_last_name').value;
            const fullName = `${firstName} ${lastName}`.trim();
            
            const submitBtn = sendEmailForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '{% trans "Sending..." %}';
            submitBtn.disabled = true;
            
            // Function to send the email
            const sendEmail = function(emailId) {
                const data = {
                    email: email,
                    send_immediately: true,  // Send immediately, don't use wait time
                    variables: {
                        first_name: firstName,
                        last_name: lastName,
                        full_name: fullName,
                        email: email
                    }
                };
                
                const url = `/api/campaigns/${campaignId}/emails/${emailId}/send/`;
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json().then(data => ({status: response.status, body: data})))
                .then(({status, body}) => {
                    if (status !== 200) {
                        const errorMsg = body.error || '{% trans "An error occurred while sending the email. Please try again." %}';
                        alert(errorMsg);
                    } else {
                        sendEmailModal.classList.add('hidden');
                        sendEmailForm.reset();
                        alert(body.message || '{% trans "Email sent successfully!" %}');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('{% trans "An error occurred while sending the email. Please try again." %}');
                })
                .finally(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
            };
            
            // If template is not saved, save it first
            if (!templateId) {
                // Get form data and preserve Summernote spacing/paragraphs
                const htmlContent = prepareHtmlForSaving(getSummernoteHtml(summernoteEditor));
                const footerSelect = document.getElementById('footer_select');
                const selectedFooterId = footerSelect.value;
                
                const waitTimeInput = document.getElementById('wait_time');
                const waitTimeValue = waitTimeInput.value.trim();
                const waitTime = waitTimeValue ? parseInt(waitTimeValue, 10) : 0;
                
                // Validate wait_time (0 is allowed for immediate sending)
                if (isNaN(waitTime) || waitTime < 0) {
                    alert('{% trans "Wait time must be a number greater than or equal to 0 (0 = send immediately)." %}');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const templateData = {
                    subject: document.getElementById('subject').value,
                    wait_time: waitTime,
                    wait_unit: document.getElementById('wait_unit').value,
                    body_html: htmlContent,
                    body_text: getSummernoteText(summernoteEditor)
                };
                
                if (selectedFooterId && selectedFooterId.trim()) {
                    templateData.footer_id = selectedFooterId;
                }
                
                // Save template first
                fetch(`/api/campaigns/${campaignId}/emails/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(templateData)
                })
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message, but handle HTML responses
                        return response.text().then(text => {
                            let errorMsg = 'Failed to save template';
                            try {
                                const errorData = JSON.parse(text);
                                errorMsg = errorData.error || errorMsg;
                            } catch (e) {
                                // Response is HTML, not JSON
                                errorMsg = `Server error (${response.status}): ${text.substring(0, 100)}`;
                            }
                            throw new Error(errorMsg);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Template saved, now send email
                    sendEmail(data.id);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('{% trans "Failed to save template: " %}' + error.message);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
            } else {
                // Template already exists, just send
                sendEmail(templateId);
            }
        });
    }
    
    // Form submission
    if (templateForm) {
        templateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (showCampaignModal) {
                // If campaign modal should be shown, don't submit - the button click handler will show modal
                return;
            }
            
            // Show loading state
            const submitBtn = templateForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '{% trans "Saving..." %}';
            submitBtn.disabled = true;
            
            // Get content from editor and preserve Summernote spacing/paragraphs
            const htmlContent = prepareHtmlForSaving(getSummernoteHtml(summernoteEditor));
            
            // Get selected footer
            const footerSelect = document.getElementById('footer_select');
            const selectedFooterId = footerSelect.value;
            
            // Get wait_time value and ensure it's a valid integer
            const waitTimeInput = document.getElementById('wait_time');
            const waitUnitSelect = document.getElementById('wait_unit');
            const waitTimeValue = waitTimeInput.value.trim();
            const waitTime = waitTimeValue ? parseInt(waitTimeValue, 10) : 0;
            
            // Validate wait_time (0 is allowed for immediate sending)
            if (isNaN(waitTime) || waitTime < 0) {
                alert('{% trans "Wait time must be a number greater than or equal to 0 (0 = send immediately)." %}');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            // Get wait_unit value even if disabled
            const waitUnit = waitUnitSelect.value || 'minutes';
            
            const data = {
                subject: document.getElementById('subject').value,
                wait_time: waitTime,
                wait_unit: waitUnit,
                body_html: htmlContent,
                body_text: getSummernoteText(summernoteEditor)
            };
            
            // Only add footer_id if a footer is selected
            if (selectedFooterId && selectedFooterId.trim()) {
                data.footer_id = selectedFooterId;
            }
            
            const url = templateId 
                ? `/api/campaigns/${campaignId}/emails/${templateId}/`
                : `/api/campaigns/${campaignId}/emails/`;
            
            console.log('Submitting data:', data);
            console.log('URL:', url);
            
            fetch(url, {
                method: templateId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Network response was not ok');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                alert('{% trans "Template saved successfully!" %}');
                // Redirect to campaign edit page
                window.location.href = `/campaigns/${campaignId}/edit/{% if agent %}?agent={{ agent }}{% endif %}`;
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = '{% trans "An error occurred while saving the template. Please try again." %}';
                if (error.message) {
                    errorMessage += '\n\nError: ' + error.message;
                }
                alert(errorMessage);
            })
            .finally(() => {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Test email form submission
    if (testForm) {
        testForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('test_email').value;
            const firstName = document.getElementById('test_first_name').value;
            const lastName = document.getElementById('test_last_name').value;
            const fullName = `${firstName} ${lastName}`.trim();
            
            const data = {
                email: email,
                variables: {
                    first_name: firstName,
                    last_name: lastName,
                    full_name: fullName,
                    email: email
                }
            };
            
            // The URL must include the email_id (templateId)
            if (!templateId) {
                alert('{% trans "Please save the email template first before sending a test email." %}');
                return;
            }
            
            const url = `/api/campaigns/${campaignId}/emails/${templateId}/test/`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                if (status !== 200) {
                    // Show the actual error message from the server
                    const errorMsg = body.error || '{% trans "An error occurred while sending the test email. Please try again." %}';
                    alert(errorMsg);
                } else {
                    closeTestModal();
                    alert('{% trans "Test email sent successfully!" %}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% trans "An error occurred while sending the test email. Please try again." %}');
            });
        });
    }
});

function closePreviewModal() {
    document.getElementById('previewModal').classList.add('hidden');
}

function closeTestModal() {
    document.getElementById('testModal').classList.add('hidden');
}

function copyApiKey() {
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const copyButton = apiKeyInput.nextElementSibling;
    const originalText = copyButton.textContent;
    copyButton.textContent = '{% trans "Copied!" %}';
    setTimeout(() => {
        copyButton.textContent = originalText;
    }, 2000);
}

function regenerateApiKey() {
    if (!confirm('{% trans "Are you sure you want to regenerate your API key? This will invalidate your current key and you will need to update any applications using it." %}')) {
        return;
    }
    
    const regenerateButton = document.querySelector('button[onclick="regenerateApiKey()"]');
    const originalText = regenerateButton.textContent;
    regenerateButton.textContent = '{% trans "Regenerating..." %}';
    regenerateButton.disabled = true;
    
    fetch('/api/regenerate-key/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the API key input
            document.getElementById('apiKey').value = data.api_key;
            
            // Update all API examples with the new key
            updateApiExamples(data.api_key);
            
            alert('{% trans "API key regenerated successfully!" %}');
        } else {
            alert('{% trans "Error regenerating API key. Please try again." %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error regenerating API key. Please try again." %}');
    })
    .finally(() => {
        regenerateButton.textContent = originalText;
        regenerateButton.disabled = false;
    });
}

function updateApiExamples(newApiKey) {
    // Update all API examples with the new key
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        let content = block.textContent;
        // Replace the API key in all code examples
        content = content.replace(/Bearer [A-Za-z0-9]+/g, `Bearer ${newApiKey}`);
        block.textContent = content;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Footer form submission
document.getElementById('newFooterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('footerName').value;
    const htmlContent = cleanEditorContent(getSummernoteHtml(summernoteFooterEditor));
    const isDefault = document.getElementById('isDefault').checked;
    
    if (!name.trim()) {
        alert('{% trans "Please enter a footer name." %}');
        return;
    }
    
    if (!htmlContent.trim()) {
        alert('{% trans "Please enter footer content." %}');
        return;
    }
    
    const data = {
        name: name,
        html_content: htmlContent,
        is_default: isDefault
    };
    
    fetch('/api/footers/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Add new footer to dropdown
            const select = document.getElementById('footer_select');
            const option = document.createElement('option');
            option.value = data.footer_id;
            option.textContent = name;
            if (isDefault) {
                option.selected = true;
            }
            select.appendChild(option);
            
            // Close modal and reset form
            document.getElementById('newFooterModal').classList.add('hidden');
            document.getElementById('newFooterForm').reset();
            clearSummernote(summernoteFooterEditor);
            
            // Show success message
            alert('{% trans "Footer created successfully!" %}');
        } else {
            alert('{% trans "Error creating footer. Please try again." %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error creating footer. Please try again." %}');
    });
});
</script>
{% endblock %}
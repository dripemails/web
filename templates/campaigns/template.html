{% extends "base.html" %}
{% load i18n %}
{% load i18n static %}

{% block title %}{% trans "Email Template" %} - DripEmails.org{% endblock %}

{% block extra_head %}
<!-- Quill.js - Free WYSIWYG Editor -->
<link href="{% static 'js/quill.core.css' %}" rel="stylesheet">
<link href="{% static 'js/quill.snow.css' %}" rel="stylesheet">
<script src="{% static 'js/quill.min.js' %}"></script>
<style>
    .ql-editor {
        min-height: 300px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
    }
    
    /* Ensure variables don't carry background styling when copied */
    .variable-code {
        background: transparent !important;
        color: #374151;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        padding: 0;
        border: none;
        border-radius: 0;
    }
    
    /* Override any inherited styles for copied content */
    .variable-code:focus,
    .variable-code:active,
    .variable-code:hover {
        background: transparent !important;
        color: #374151 !important;
    }
    
    /* Footer modal responsive sizing */
    #footerEditor .ql-editor {
        min-height: 200px;
        max-height: calc(90vh - 300px);
        overflow-y: auto;
    }
    
    #footerEditor .ql-container {
        height: auto;
        min-height: 200px;
        max-height: calc(90vh - 300px);
    }
    
    /* Ensure modal is responsive on mobile */
    @media (max-width: 768px) {
        #newFooterModal .bg-white {
            margin: 1rem;
            max-width: calc(100vw - 2rem);
        }
        
        #footerEditor .ql-editor {
            min-height: 150px;
            max-height: calc(90vh - 250px);
        }
        
        #footerEditor .ql-container {
            min-height: 150px;
            max-height: calc(90vh - 250px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            {% if not campaign %}
            <!-- Campaign Selection Alert -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-yellow-700">
                            <strong>{% trans "No campaign selected." %}</strong> {% trans "You'll be prompted to select a campaign when you save this template." %}
                        </p>
                        <div class="mt-2">
                            <label for="campaign_selector" class="block text-sm font-medium text-yellow-900 mb-1">{% trans "Or select a campaign now:" %}</label>
                            <select id="campaign_selector" class="block w-full md:w-1/2 rounded-md border-yellow-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500">
                                <option value="">-- {% trans "Select a campaign (optional)" %} --</option>
                                {% for c in all_campaigns %}
                                    <option value="{{ c.id }}">{{ c.name }}{% if c.is_active %} ({% trans "Active" %}){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="bg-indigo-600 py-6 px-8 text-white">
                    <h1 class="text-2xl font-bold">{% trans "Email Template" %}</h1>
                    <p class="text-indigo-100">{% if campaign %}{{ campaign.name }}{% else %}{% trans "Design your email template" %}{% endif %}</p>
                </div>
                
                <form id="templateForm" class="p-8" method="POST" action="{% if template %}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/{% else %}/api/campaigns/{{ campaign.id }}/emails/{% endif %}">
                    {% csrf_token %}
                    <div class="space-y-6">
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700">{% trans "Email Subject" %}</label>
                            <input type="text" id="subject" name="subject" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label for="wait_time" class="block text-sm font-medium text-gray-700">{% trans "Wait Time" %}</label>
                            <div class="mt-1 flex space-x-3">
                                <input type="number" id="wait_time" name="wait_time" min="0" required
                                       class="block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <select id="wait_unit" name="wait_unit" required
                                        class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    {% for value, label in wait_units %}
                                        <option value="{{ value }}" {% if template and template.wait_unit == value %}selected{% elif not template and value == 'days' %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">
                                {% trans "Time to wait before sending this email after the previous one (0 = send immediately)" %}
                            </p>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-medium text-gray-900">{% trans "Email Content" %}</h2>
                                <div class="flex space-x-2">
                                    <button type="button" id="aiGenerateBtn" class="inline-flex items-center px-3 py-2 border border-green-300 shadow-sm text-sm leading-4 font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        ✨ {% trans "AI Generate" %}
                                    </button>
                                    <button type="button" id="previewBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Preview" %}
                                    </button>
                                    <button type="button" id="testBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Send Test" %}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">{% trans "Available Variables" %} <span class="text-xs text-gray-500">({% trans "Click to copy" %})</span></h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{first_name}}', this)">
                                        <code class="variable-code">{{first_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{last_name}}', this)">
                                        <code class="variable-code">{{last_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{full_name}}', this)">
                                        <code class="variable-code">{{full_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{email}}', this)">
                                        <code class="variable-code">{{email}}</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="body_html" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Email Content" %}</label>
                                <div id="editor" class="border border-gray-300 rounded-md"></div>
                                <textarea id="body_html" name="body_html" style="display: none;"></textarea>
                            </div>
                            
                            <div class="mt-4">
                                <label for="footer_select" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Email Footer" %}</label>
                                <div class="flex space-x-2">
                                    <select id="footer_select" name="footer_id" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">{% trans "No footer" %}</option>
                                        {% for footer in user_footers %}
                                            <option value="{{ footer.id }}" {% if footer.is_default %}selected{% endif %}>{{ footer.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" id="newFooterBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        {% trans "New Footer" %}
                                    </button>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    {% trans "Select a footer to append to your email, or leave empty for no footer." %}
                                </p>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h2 class="text-lg font-medium text-gray-900 mb-4">{% trans "API Integration" %}</h2>
                            
                            <!-- API Key Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-700">{% trans "Your API Key" %}</h3>
                                        <p class="text-sm text-gray-500 mt-1">{% trans "Use this key to authenticate your API requests" %}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="apiKey" value="{% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}{% trans 'No API key found. Please contact support.' %}{% endif %}" readonly
                                               class="block w-64 rounded-md border-gray-300 bg-gray-100 text-sm font-mono">
                                        <button type="button" onclick="copyApiKey()" 
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% trans "Copy" %}
                                        </button>
                                        <button type="button" onclick="regenerateApiKey()" 
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% trans "Regenerate" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {% if template %}
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <p class="text-sm text-gray-600">
                                    {% trans "Send emails using this template via API. Here's how to trigger this template programmatically:" %}
                                </p>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "Python" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>import requests

        url = "{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/"
headers = {
    "Authorization": "Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}",
    "Content-Type": "application/json"
}
data = {
    "email": "subscriber@example.com",
    "variables": {
        "first_name": "John",
        "last_name": "Doe"
    }
}

response = requests.post(url, json=data, headers=headers)</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "JavaScript" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>fetch("{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/", {
    method: "POST",
    headers: {
        "Authorization": "Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}",
        "Content-Type": "application/json"
    },
    body: JSON.stringify({
        email: "subscriber@example.com",
        variables: {
            first_name: "John",
            last_name: "Doe"
        }
    })
})</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "Ruby" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>require 'net/http'
require 'json'

uri = URI("{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/")
headers = {
    'Authorization' => 'Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}',
    'Content-Type' => 'application/json'
}
data = {
    email: 'subscriber@example.com',
    variables: {
        first_name: 'John',
        last_name: 'Doe'
    }
}

http = Net::HTTP.new(uri.host, uri.port)
request = Net::HTTP::Post.new(uri.request_uri, headers)
request.body = data.to_json
response = http.request(request)</code></pre>
                                </div>
                            </div>
                            {% else %}
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                <p class="text-sm text-yellow-800">
                                    {% trans "Save your email template first to see the API code for sending emails." %}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center justify-between pt-6">
                            <button type="button" onclick="history.back()" class="text-gray-600 hover:text-gray-800">
                                {% trans "Cancel" %}
                            </button>
                            <div class="flex space-x-3">
                                <button type="{% if show_campaign_modal %}button{% else %}submit{% endif %}" {% if show_campaign_modal %}onclick="showCampaignModal()"{% endif %} class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    {% trans "Save Template" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Campaign Selection Modal -->
    {% if show_campaign_modal %}
    <div id="campaignModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Select Campaign" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Choose which campaign to save this template to" %}</p>
            </div>
            <div class="p-6">
                <label for="modal_campaign_select" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Campaign" %}</label>
                <select id="modal_campaign_select" required
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="">-- {% trans "Select a campaign" %} --</option>
                    {% for c in all_campaigns %}
                        <option value="{{ c.id }}">{{ c.name }}{% if c.is_active %} ({% trans "Active" %}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                <button type="button" onclick="hideCampaignModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                    {% trans "Cancel" %}
                </button>
                <button type="button" onclick="submitWithCampaign()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {% trans "Save Template" %}
                </button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- AI Generate Modal -->
    <div id="aiModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">✨ {% trans "Generate Email with AI" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Describe what you want in your email and let AI create the content" %}</p>
            </div>
            <form id="aiGenerateForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="ai_subject_topic" class="block text-sm font-medium text-gray-700">{% trans "What is the email about?" %}</label>
                        <input type="text" id="ai_subject_topic" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                               placeholder="{% trans 'e.g., New product launch, special discount offer, welcome to our service...' %}">
                        <p class="mt-1 text-xs text-gray-500">{% trans "Describe the main topic or purpose of the email" %}</p>
                    </div>
                    
                    <div>
                        <label for="ai_context" class="block text-sm font-medium text-gray-700">{% trans "Email Details" %}</label>
                        <textarea id="ai_context" rows="4"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                  placeholder="Provide specific details:
- What action do you want readers to take?
- Any special offers or key information?
- Brand voice or personality to use?
- Call to action?"></textarea>
                        <p class="mt-1 text-xs text-gray-500">{% trans "Include any specific details, offers, key points, or instructions you want included" %}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="ai_recipient" class="block text-sm font-medium text-gray-700">{% trans "Who is this for?" %}</label>
                            <input type="text" id="ai_recipient"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                   placeholder="{% trans 'e.g., customers, subscribers, users...' %}" value="subscriber">
                        </div>
                        <div>
                            <label for="ai_tone" class="block text-sm font-medium text-gray-700">{% trans "Tone" %}</label>
                            <select id="ai_tone"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                <option value="professional">{% trans "Professional" %}</option>
                                <option value="friendly">{% trans "Friendly" %}</option>
                                <option value="persuasive">{% trans "Persuasive" %}</option>
                                <option value="casual">{% trans "Casual" %}</option>
                                <option value="formal">{% trans "Formal" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="ai_length" class="block text-sm font-medium text-gray-700">{% trans "Email Length" %}</label>
                        <select id="ai_length"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <option value="short">{% trans "Short (concise, 2-3 paragraphs)" %}</option>
                            <option value="medium" selected>{% trans "Medium (balanced, 4-5 paragraphs)" %}</option>
                            <option value="long">{% trans "Long (detailed, 6+ paragraphs)" %}</option>
                        </select>
                    </div>
                    
                    {% comment %}
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-md">
                        <p class="text-sm text-blue-800">
                            ℹ️ {% trans "AI generation uses Hugging Face API to create email content. The generated subject and body will replace your current email." %}
                        </p>
                    </div>
                    {% endcomment %}
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" id="cancelAiGenerate" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            ✨ {% trans "Generate Email" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Email Preview" %}</h3>
                <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">{% trans "Close" %}</span>
                    ×
                </button>
            </div>
            <div class="p-6">
                <div id="previewContent" class="prose max-w-none"></div>
            </div>
        </div>
    </div>
    
    <!-- Test Email Modal -->
    <div id="testModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Send Test Email" %}</h3>
            </div>
            <form id="testForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="test_email" class="block text-sm font-medium text-gray-700">{% trans "Email Address" %}</label>
                        <input type="email" id="test_email" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="test_first_name" class="block text-sm font-medium text-gray-700">{% trans "First Name" %}</label>
                        <input type="text" id="test_first_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter first name...' %}">
                    </div>
                    <div>
                        <label for="test_last_name" class="block text-sm font-medium text-gray-700">{% trans "Last Name" %}</label>
                        <input type="text" id="test_last_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter last name...' %}">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeTestModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            {% trans "Send" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Footer Modal -->
    <div id="newFooterModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Create New Footer" %}</h3>
            </div>
            <form id="newFooterForm" class="px-6 py-4 flex-1 flex flex-col overflow-hidden">
                <div class="space-y-4 flex-1 flex flex-col">
                    <div class="flex-shrink-0">
                        <label for="footerName" class="block text-sm font-medium text-gray-700 mb-1">
                            {% trans "Footer Name" %}
                        </label>
                        <input type="text" id="footerName" name="name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter footer name...' %}">
                    </div>
                    <div class="flex-1 flex flex-col min-h-0">
                        <label for="footerContent" class="block text-sm font-medium text-gray-700 mb-1 flex-shrink-0">
                            {% trans "Footer Content (HTML)" %}
                        </label>
                        <div class="flex-1 min-h-0">
                            <div id="footerEditor" class="border border-gray-300 rounded-md h-full"></div>
                        </div>
                        <textarea id="footerContent" name="html_content" style="display: none;"></textarea>
                        <p class="mt-1 text-sm text-gray-500 flex-shrink-0">
                            {% trans "Enter the HTML content for your footer. You can use variables like {{first_name}}, {{last_name}}, {{email}}, etc." %}
                        </p>
                    </div>
                    <div class="flex items-center flex-shrink-0">
                        <input type="checkbox" id="isDefault" name="is_default" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="isDefault" class="ml-2 block text-sm text-gray-900">
                            {% trans "Set as default footer" %}
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6 flex-shrink-0 border-t border-gray-200 pt-4">
                    <button type="button" id="cancelNewFooter" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        {% trans "Create Footer" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// @ts-nocheck - Django template variables used throughout
// Global variables for Quill editors
let quill;
let footerQuill;

// Function to clean HTML content by removing empty paragraph tags with breaks
// This removes leading/trailing empty paragraphs and collapses consecutive ones,
// but preserves single empty paragraphs between content (intentional spacing)
function cleanQuillContent(html) {
    if (!html) return html;
    
    // Remove leading empty paragraphs
    html = html.replace(/^(<p><br\s*\/?><\/p>\s*)+/gi, '');
    
    // Remove trailing empty paragraphs
    html = html.replace(/(<p><br\s*\/?><\/p>\s*)+$/gi, '');
    
    // Collapse multiple consecutive empty paragraphs to a single one (preserves intentional spacing)
    // This replaces 2+ consecutive empty paragraphs with just one
    html = html.replace(/(<p><br\s*\/?><\/p>\s*){2,}/gi, '<p><br></p>');
    
    return html;
}

// Function to copy variable to clipboard and insert into editor
function copyVariable(variable, element) {
    // Copy to clipboard
    navigator.clipboard.writeText(variable).then(function() {
        // Insert into Quill editor at current cursor position
        if (quill) {
            const range = quill.getSelection();
            if (range) {
                quill.insertText(range.index, variable);
                quill.setSelection(range.index + variable.length);
            } else {
                // If no selection, append to end
                const length = quill.getLength();
                quill.insertText(length - 1, variable);
                quill.setSelection(length + variable.length - 1);
            }
        }
        
        // Show brief success feedback
        if (element) {
            const originalBg = element.style.backgroundColor;
            element.style.backgroundColor = '#10B981';
            setTimeout(() => {
                element.style.backgroundColor = originalBg;
            }, 200);
        }
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        alert('{% trans "Could not copy variable. Please try again." %}');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editor
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: '{% trans "Enter your email content here..." %}'
    });
    
    // Campaign modal functions
    const showCampaignModal = "{{ show_campaign_modal|default:False|lower }}" === "true";
    
    // Handle campaign selector at top of page
    const campaignSelector = document.getElementById('campaign_selector');
    if (campaignSelector && showCampaignModal) {
        campaignSelector.addEventListener('change', function() {
            if (this.value) {
                // Redirect to template page with selected campaign
                window.location.href = `/campaigns/template/${this.value}/`;
            }
        });
    }
    
    if (showCampaignModal) {
        window.showCampaignModal = function() {
        // Check if user selected a campaign from the top selector
        const topCampaignSelector = document.getElementById('campaign_selector');
        if (topCampaignSelector && topCampaignSelector.value) {
            // Use the selected campaign from top selector
            submitWithSpecificCampaign(topCampaignSelector.value);
            return;
        }
        
        // Otherwise show modal for selection
        // Validate form first
        const subject = document.getElementById('subject').value.trim();
        const bodyContent = cleanQuillContent(quill.root.innerHTML.trim());
        
        if (!subject) {
            alert('{% trans "Please enter an email subject." %}');
            return;
        }
        
        if (!bodyContent || bodyContent === '<p><br></p>') {
            alert('{% trans "Please enter email content." %}');
            return;
        }
        
        document.getElementById('campaignModal').classList.remove('hidden');
    };
    
    window.hideCampaignModal = function() {
        document.getElementById('campaignModal').classList.add('hidden');
    };
    
    window.submitWithCampaign = function() {
        const selectedCampaignId = document.getElementById('modal_campaign_select').value;
        
        if (!selectedCampaignId) {
            alert('{% trans "Please select a campaign." %}');
            return;
        }
        
        submitWithSpecificCampaign(selectedCampaignId);
    };
    
    window.submitWithSpecificCampaign = function(selectedCampaignId) {
        // Close modal if open
        const modal = document.getElementById('campaignModal');
        if (modal && !modal.classList.contains('hidden')) {
            hideCampaignModal();
        }
        hideCampaignModal();
        
        // Get form data
        const htmlContent = cleanQuillContent(quill.root.innerHTML);
        const footerSelect = document.getElementById('footer_select');
        const selectedFooterId = footerSelect.value;
        
        // Get wait_time value and ensure it's a valid integer
        const waitTimeInput = document.getElementById('wait_time');
        const waitTimeValue = waitTimeInput.value.trim();
        const waitTime = waitTimeValue ? parseInt(waitTimeValue, 10) : 1;
        
        // Validate wait_time
        if (isNaN(waitTime) || waitTime < 1) {
            alert('{% trans "Wait time must be a number greater than 0." %}');
            return;
        }
        
        const data = {
            subject: document.getElementById('subject').value,
            wait_time: waitTime,
            wait_unit: document.getElementById('wait_unit').value,
            body_html: htmlContent,
            body_text: quill.getText().trim() // Use Quill's getText() for proper plain text
        };
        
        // Only add footer_id if a footer is selected
        if (selectedFooterId && selectedFooterId.trim()) {
            data.footer_id = selectedFooterId;
        }
        
        // Submit via API
        fetch(`/api/campaigns/${selectedCampaignId}/emails/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Validation failed');
                });
            }
            return response.json();
        })
        .then(data => {
            alert('{% trans "Template saved successfully!" %}');
            // Redirect to the campaign template page
            window.location.href = `/campaigns/template/${selectedCampaignId}/`;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "An error occurred while saving the template: " %}' + error.message);
        });
    };
    
        // Close modal when clicking outside
        document.getElementById('campaignModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCampaignModal();
            }
        });
    }
    
    // Initialize footer editor
    footerQuill = new Quill('#footerEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link'],
                ['clean']
            ]
        },
        placeholder: '{% trans "Enter footer content here..." %}'
    });
    
    const aiGenerateBtn = document.getElementById('aiGenerateBtn');
    const aiModal = document.getElementById('aiModal');
    const aiGenerateForm = document.getElementById('aiGenerateForm');
    const cancelAiGenerate = document.getElementById('cancelAiGenerate');
    
    const previewBtn = document.getElementById('previewBtn');
    const testBtn = document.getElementById('testBtn');
    const previewModal = document.getElementById('previewModal');
    const testModal = document.getElementById('testModal');
    const templateForm = document.getElementById('templateForm');
    const testForm = document.getElementById('testForm');
    const campaignId = '{{ campaign.id }}';
    const templateId = '{{ template.id|default:"" }}';
    
    // Debug: Log campaignId and templateId
    console.log('campaignId:', campaignId);
    console.log('templateId:', templateId);
    // Footer modal elements
    const newFooterBtn = document.getElementById('newFooterBtn');
    const newFooterModal = document.getElementById('newFooterModal');
    const cancelNewFooter = document.getElementById('cancelNewFooter');
    const newFooterForm = document.getElementById('newFooterForm');
    
    // Load template data if editing
    if (templateId) {
        fetch(`/api/campaigns/${campaignId}/emails/${templateId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('subject').value = data.subject;
                document.getElementById('wait_time').value = data.wait_time;
                document.getElementById('wait_unit').value = data.wait_unit;
                
                // Set content in Quill editor
                quill.root.innerHTML = cleanQuillContent(data.body_html);
                
                // Set footer if available
                if (data.footer_id) {
                    document.getElementById('footer_select').value = data.footer_id;
                }
            })
            .catch(error => {
                console.error('Error loading template:', error);
                alert('{% trans "An error occurred while loading the template. Please try again." %}');
            });
    }
    
    // AI Generate functionality - Show modal for user input
    if (aiGenerateBtn) {
        aiGenerateBtn.addEventListener('click', function() {
            // Check if campaignId is empty
            if (!campaignId || campaignId.trim() === '') {
                alert('{% trans "Error: Campaign ID is missing. Please select a campaign first." %}');
                return;
            }
            
            // Show the modal instead of auto-generating
            aiModal.classList.remove('hidden');
            document.getElementById('ai_subject_topic').focus();
        });
    }
    
    // Keep cancel functionality for modal in case it's still needed elsewhere
    if (cancelAiGenerate) {
        cancelAiGenerate.addEventListener('click', function() {
            aiModal.classList.add('hidden');
            aiGenerateForm.reset();
        });
    }
    
    if (aiModal) {
        aiModal.addEventListener('click', function(e) {
            if (e.target === aiModal) {
                aiModal.classList.add('hidden');
                aiGenerateForm.reset();
            }
        });
    }
    
    // Form submission for modal (in case user opens it manually)
    if (aiGenerateForm) {
        aiGenerateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const topic = document.getElementById('ai_subject_topic').value;
            const recipient = document.getElementById('ai_recipient').value;
            const tone = document.getElementById('ai_tone').value;
            const length = document.getElementById('ai_length').value;
            const context = document.getElementById('ai_context').value;
            
            const submitBtn = aiGenerateForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '✨ {% trans "Generating..." %}';
            submitBtn.disabled = true;
            
            const data = {
                subject_topic: topic,
                recipient: recipient,
                tone: tone,
                length: length,
                context: context,
                email_id: templateId || null
            };
            
            // Create AbortController for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutes timeout
            
            fetch(`/api/campaigns/${campaignId}/generate-email/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    // Try to get error details from response
                    return response.text().then(text => {
                        let errorData = null;
                        try {
                            errorData = JSON.parse(text);
                        } catch (e) {
                            // Response is not JSON
                            throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
                        }
                        const errorMsg = errorData.error || errorData.detail || errorData.message || 'Failed to generate email';
                        throw new Error(errorMsg);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.subject) {
                    document.getElementById('subject').value = data.subject;
                    quill.root.innerHTML = cleanQuillContent(data.body_html);
                    aiModal.classList.add('hidden');
                    aiGenerateForm.reset();
                    alert('{% trans "Email generated successfully! Review and save when ready." %}');
                } else {
                    alert('{% trans "Error: Invalid response from AI service." %}');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('AI Generation Error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                
                let errorMsg = '{% trans "Failed to generate email. " %}';
                
                // Handle different error types
                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    errorMsg += '{% trans "Request timed out after 5 minutes. The AI generation is taking too long. Please try again or check server resources." %}';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += '{% trans "Network error: Could not connect to server. Please check your connection and try again." %}';
                } else if (error.message.includes('Ollama')) {
                    errorMsg += error.message;
                } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                    errorMsg += '{% trans "Request timed out. The AI generation is taking too long. Please try again." %}';
                } else if (error.message.includes('500') || error.message.includes('server error')) {
                    errorMsg += error.message + ' {% trans "Please check the server logs for more details." %}';
                } else if (error.message.includes('404') || error.message.includes('not found')) {
                    errorMsg += error.message + ' {% trans "Please ensure Ollama is running on the server." %}';
                } else {
                    // Show the actual error message
                    errorMsg += error.message || '{% trans "Unknown error occurred. Please check the browser console and server logs for details." %}';
                }
                
                alert(errorMsg);
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Preview functionality
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            const content = cleanQuillContent(quill.root.innerHTML);
            
            // Get selected footer content
            const footerSelect = document.getElementById('footer_select');
            const selectedFooterId = footerSelect.value;
            let footerContent = '';
            
            if (selectedFooterId) {
                // Find the footer content from the options
                const footerOption = footerSelect.querySelector(`option[value="${selectedFooterId}"]`);
                if (footerOption) {
                    // This is a simplified approach - in a real implementation, you'd fetch the footer content
                    footerContent = '<hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;"><div style="font-size: 12px; color: #6b7280;">{% trans "[Footer content would appear here]" %}</div>';
                }
            }
            
            document.getElementById('previewContent').innerHTML = content + footerContent;
            previewModal.classList.remove('hidden');
        });
    }
    
    // Test email functionality
    if (testBtn) {
        testBtn.addEventListener('click', function() {
            testModal.classList.remove('hidden');
        });
    }
    
    // Footer modal functionality
    if (newFooterBtn) {
        newFooterBtn.addEventListener('click', function() {
            newFooterModal.classList.remove('hidden');
            document.getElementById('footerName').focus();
        });
    }
    
    if (cancelNewFooter) {
        cancelNewFooter.addEventListener('click', function() {
            newFooterModal.classList.add('hidden');
            newFooterForm.reset();
            footerQuill.setContents([]);
        });
    }
    
    // Close footer modal when clicking outside
    if (newFooterModal) {
        newFooterModal.addEventListener('click', function(e) {
            if (e.target === newFooterModal) {
                newFooterModal.classList.add('hidden');
                newFooterForm.reset();
                footerQuill.setContents([]);
            }
        });
    }
    
    // Form submission
    if (templateForm) {
        templateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (showCampaignModal) {
                // If campaign modal should be shown, don't submit - the button click handler will show modal
                return;
            }
            
            // Show loading state
            const submitBtn = templateForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '{% trans "Saving..." %}';
            submitBtn.disabled = true;
            
            // Get content from Quill editor
            const htmlContent = cleanQuillContent(quill.root.innerHTML);
            
            // Get selected footer
            const footerSelect = document.getElementById('footer_select');
            const selectedFooterId = footerSelect.value;
            
            // Get wait_time value and ensure it's a valid integer
            const waitTimeInput = document.getElementById('wait_time');
            const waitTimeValue = waitTimeInput.value.trim();
            const waitTime = waitTimeValue ? parseInt(waitTimeValue, 10) : 1;
            
            // Validate wait_time
            if (isNaN(waitTime) || waitTime < 1) {
                alert('{% trans "Wait time must be a number greater than 0." %}');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const data = {
                subject: document.getElementById('subject').value,
                wait_time: waitTime,
                wait_unit: document.getElementById('wait_unit').value,
                body_html: htmlContent,
                body_text: quill.getText().trim() // Use Quill's getText() for proper plain text
            };
            
            // Only add footer_id if a footer is selected
            if (selectedFooterId && selectedFooterId.trim()) {
                data.footer_id = selectedFooterId;
            }
            
            const url = templateId 
                ? `/api/campaigns/${campaignId}/emails/${templateId}/`
                : `/api/campaigns/${campaignId}/emails/`;
            
            console.log('Submitting data:', data);
            console.log('URL:', url);
            
            fetch(url, {
                method: templateId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Network response was not ok');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                alert('{% trans "Template saved successfully!" %}');
                // Redirect to campaign edit page
                window.location.href = `/campaigns/${campaignId}/edit/`;
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = '{% trans "An error occurred while saving the template. Please try again." %}';
                if (error.message) {
                    errorMessage += '\n\nError: ' + error.message;
                }
                alert(errorMessage);
            })
            .finally(() => {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Test email form submission
    if (testForm) {
        testForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('test_email').value;
            const firstName = document.getElementById('test_first_name').value;
            const lastName = document.getElementById('test_last_name').value;
            const fullName = `${firstName} ${lastName}`.trim();
            
            const data = {
                email: email,
                variables: {
                    first_name: firstName,
                    last_name: lastName,
                    full_name: fullName,
                    email: email
                }
            };
            
            // The URL must include the email_id (templateId)
            if (!templateId) {
                alert('{% trans "Please save the email template first before sending a test email." %}');
                return;
            }
            
            const url = `/api/campaigns/${campaignId}/emails/${templateId}/test/`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                if (status !== 200) {
                    // Show the actual error message from the server
                    const errorMsg = body.error || '{% trans "An error occurred while sending the test email. Please try again." %}';
                    alert(errorMsg);
                } else {
                    closeTestModal();
                    alert('{% trans "Test email sent successfully!" %}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% trans "An error occurred while sending the test email. Please try again." %}');
            });
        });
    }
});

function closePreviewModal() {
    document.getElementById('previewModal').classList.add('hidden');
}

function closeTestModal() {
    document.getElementById('testModal').classList.add('hidden');
}

function copyApiKey() {
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const copyButton = apiKeyInput.nextElementSibling;
    const originalText = copyButton.textContent;
    copyButton.textContent = '{% trans "Copied!" %}';
    setTimeout(() => {
        copyButton.textContent = originalText;
    }, 2000);
}

function regenerateApiKey() {
    if (!confirm('{% trans "Are you sure you want to regenerate your API key? This will invalidate your current key and you will need to update any applications using it." %}')) {
        return;
    }
    
    const regenerateButton = document.querySelector('button[onclick="regenerateApiKey()"]');
    const originalText = regenerateButton.textContent;
    regenerateButton.textContent = '{% trans "Regenerating..." %}';
    regenerateButton.disabled = true;
    
    fetch('/api/regenerate-key/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the API key input
            document.getElementById('apiKey').value = data.api_key;
            
            // Update all API examples with the new key
            updateApiExamples(data.api_key);
            
            alert('{% trans "API key regenerated successfully!" %}');
        } else {
            alert('{% trans "Error regenerating API key. Please try again." %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error regenerating API key. Please try again." %}');
    })
    .finally(() => {
        regenerateButton.textContent = originalText;
        regenerateButton.disabled = false;
    });
}

function updateApiExamples(newApiKey) {
    // Update all API examples with the new key
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        let content = block.textContent;
        // Replace the API key in all code examples
        content = content.replace(/Bearer [A-Za-z0-9]+/g, `Bearer ${newApiKey}`);
        block.textContent = content;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Footer form submission
document.getElementById('newFooterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('footerName').value;
    const htmlContent = cleanQuillContent(footerQuill.root.innerHTML);
    const isDefault = document.getElementById('isDefault').checked;
    
    if (!name.trim()) {
        alert('{% trans "Please enter a footer name." %}');
        return;
    }
    
    if (!htmlContent.trim()) {
        alert('{% trans "Please enter footer content." %}');
        return;
    }
    
    const data = {
        name: name,
        html_content: htmlContent,
        is_default: isDefault
    };
    
    fetch('/api/footers/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Add new footer to dropdown
            const select = document.getElementById('footer_select');
            const option = document.createElement('option');
            option.value = data.footer_id;
            option.textContent = name;
            if (isDefault) {
                option.selected = true;
            }
            select.appendChild(option);
            
            // Close modal and reset form
            document.getElementById('newFooterModal').classList.add('hidden');
            document.getElementById('newFooterForm').reset();
            footerQuill.setContents([]);
            
            // Show success message
            alert('{% trans "Footer created successfully!" %}');
        } else {
            alert('{% trans "Error creating footer. Please try again." %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error creating footer. Please try again." %}');
    });
});
</script>
{% endblock %}
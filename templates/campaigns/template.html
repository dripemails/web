{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Email Template" %} - DripEmails.org{% endblock %}

{% block extra_head %}
<!-- Quill.js - Free WYSIWYG Editor -->
<link href="{% static 'js/quill.snow.css' %}" rel="stylesheet">
<script src="{% static 'js/quill.min.js' %}"></script>
<style>
    .ql-editor {
        min-height: 300px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
    }
    
    /* Ensure variables don't carry background styling when copied */
    .variable-code {
        background: transparent !important;
        color: #374151;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        padding: 0;
        border: none;
        border-radius: 0;
    }
    
    /* Override any inherited styles for copied content */
    .variable-code:focus,
    .variable-code:active,
    .variable-code:hover {
        background: transparent !important;
        color: #374151 !important;
    }
    
    /* Footer modal responsive sizing */
    #footerEditor .ql-editor {
        min-height: 200px;
        max-height: calc(90vh - 300px);
        overflow-y: auto;
    }
    
    #footerEditor .ql-container {
        height: auto;
        min-height: 200px;
        max-height: calc(90vh - 300px);
    }
    
    /* Ensure modal is responsive on mobile */
    @media (max-width: 768px) {
        #newFooterModal .bg-white {
            margin: 1rem;
            max-width: calc(100vw - 2rem);
        }
        
        #footerEditor .ql-editor {
            min-height: 150px;
            max-height: calc(90vh - 250px);
        }
        
        #footerEditor .ql-container {
            min-height: 150px;
            max-height: calc(90vh - 250px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="bg-indigo-600 py-6 px-8 text-white">
                    <h1 class="text-2xl font-bold">{% trans "Email Template" %}</h1>
                    <p class="text-indigo-100">{% trans "Design your email template" %}</p>
                </div>
                
                <form id="templateForm" class="p-8" method="POST" action="{% if template %}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/{% else %}/api/campaigns/{{ campaign.id }}/emails/{% endif %}">
                    {% csrf_token %}
                    <div class="space-y-6">
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700">{% trans "Email Subject" %}</label>
                            <input type="text" id="subject" name="subject" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label for="wait_time" class="block text-sm font-medium text-gray-700">{% trans "Wait Time" %}</label>
                            <div class="mt-1 flex space-x-3">
                                <input type="number" id="wait_time" name="wait_time" min="1" required
                                       class="block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <select id="wait_unit" name="wait_unit" required
                                        class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    {% for value, label in wait_units %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">
                                {% trans "Time to wait before sending this email after the previous one" %}
                            </p>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-medium text-gray-900">{% trans "Email Content" %}</h2>
                                <div class="flex space-x-2">
                                    <button type="button" id="previewBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Preview" %}
                                    </button>
                                    <button type="button" id="testBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        {% trans "Send Test" %}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">{% trans "Available Variables" %} <span class="text-xs text-gray-500">({% trans "Click to copy" %})</span></h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{first_name}}', this)">
                                        <code class="variable-code">{{first_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{last_name}}', this)">
                                        <code class="variable-code">{{last_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{full_name}}', this)">
                                        <code class="variable-code">{{full_name}}</code>
                                    </div>
                                    <div class="bg-white p-2 rounded border border-gray-200 text-sm cursor-pointer hover:bg-gray-50 transition-colors" onclick="copyVariable('{{email}}', this)">
                                        <code class="variable-code">{{email}}</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="body_html" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Email Content" %}</label>
                                <div id="editor" class="border border-gray-300 rounded-md"></div>
                                <textarea id="body_html" name="body_html" style="display: none;"></textarea>
                            </div>
                            
                            <div class="mt-4">
                                <label for="footer_select" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Email Footer" %}</label>
                                <div class="flex space-x-2">
                                    <select id="footer_select" name="footer_id" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">{% trans "No footer" %}</option>
                                        {% for footer in user_footers %}
                                            <option value="{{ footer.id }}" {% if footer.is_default %}selected{% endif %}>{{ footer.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" id="newFooterBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        {% trans "New Footer" %}
                                    </button>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    {% trans "Select a footer to append to your email, or leave empty for no footer." %}
                                </p>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h2 class="text-lg font-medium text-gray-900 mb-4">{% trans "API Integration" %}</h2>
                            
                            <!-- API Key Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-700">{% trans "Your API Key" %}</h3>
                                        <p class="text-sm text-gray-500 mt-1">{% trans "Use this key to authenticate your API requests" %}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="apiKey" value="{% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}{% trans 'No API key found. Please contact support.' %}{% endif %}" readonly
                                               class="block w-64 rounded-md border-gray-300 bg-gray-100 text-sm font-mono">
                                        <button type="button" onclick="copyApiKey()" 
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% trans "Copy" %}
                                        </button>
                                        <button type="button" onclick="regenerateApiKey()" 
                                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            {% trans "Regenerate" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {% if template %}
                            <div class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <p class="text-sm text-gray-600">
                                    {% trans "Send emails using this template via API. Here's how to trigger this template programmatically:" %}
                                </p>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "Python" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>import requests

        url = "{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/"
headers = {
    "Authorization": "Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}",
    "Content-Type": "application/json"
}
data = {
    "email": "subscriber@example.com",
    "variables": {
        "first_name": "John",
        "last_name": "Doe"
    }
}

response = requests.post(url, json=data, headers=headers)</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "JavaScript" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>fetch("{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/", {
    method: "POST",
    headers: {
        "Authorization": "Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}",
        "Content-Type": "application/json"
    },
    body: JSON.stringify({
        email: "subscriber@example.com",
        variables: {
            first_name: "John",
            last_name: "Doe"
        }
    })
})</code></pre>
                                </div>
                                
                                <div class="space-y-2">
                                    <h3 class="text-sm font-medium text-gray-700">{% trans "Ruby" %}</h3>
                                    <pre class="bg-gray-800 text-white p-4 rounded-md text-sm overflow-x-auto"><code>require 'net/http'
require 'json'

uri = URI("{{ request.scheme }}://{{ request.get_host }}/api/campaigns/{{ campaign.id }}/emails/{{ template.id }}/send/")
headers = {
    'Authorization' => 'Bearer {% if request.user.auth_token %}{{ request.user.auth_token.key }}{% else %}YOUR_API_TOKEN{% endif %}',
    'Content-Type' => 'application/json'
}
data = {
    email: 'subscriber@example.com',
    variables: {
        first_name: 'John',
        last_name: 'Doe'
    }
}

http = Net::HTTP.new(uri.host, uri.port)
request = Net::HTTP::Post.new(uri.request_uri, headers)
request.body = data.to_json
response = http.request(request)</code></pre>
                                </div>
                            </div>
                            {% else %}
                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                <p class="text-sm text-yellow-800">
                                    {% trans "Save your email template first to see the API code for sending emails." %}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center justify-between pt-6">
                            <button type="button" onclick="history.back()" class="text-gray-600 hover:text-gray-800">
                                {% trans "Cancel" %}
                            </button>
                            <div class="flex space-x-3">
                                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    {% trans "Save Template" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Email Preview" %}</h3>
                <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-500">
                    <span class="sr-only">{% trans "Close" %}</span>
                    Ã—
                </button>
            </div>
            <div class="p-6">
                <div id="previewContent" class="prose max-w-none"></div>
            </div>
        </div>
    </div>
    
    <!-- Test Email Modal -->
    <div id="testModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Send Test Email" %}</h3>
            </div>
            <form id="testForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="test_email" class="block text-sm font-medium text-gray-700">{% trans "Email Address" %}</label>
                        <input type="email" id="test_email" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="test_first_name" class="block text-sm font-medium text-gray-700">{% trans "First Name" %}</label>
                        <input type="text" id="test_first_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter first name...' %}">
                    </div>
                    <div>
                        <label for="test_last_name" class="block text-sm font-medium text-gray-700">{% trans "Last Name" %}</label>
                        <input type="text" id="test_last_name" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter last name...' %}">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeTestModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            {% trans "Send" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Footer Modal -->
    <div id="newFooterModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-lg font-medium text-gray-900">{% trans "Create New Footer" %}</h3>
            </div>
            <form id="newFooterForm" class="px-6 py-4 flex-1 flex flex-col overflow-hidden">
                <div class="space-y-4 flex-1 flex flex-col">
                    <div class="flex-shrink-0">
                        <label for="footerName" class="block text-sm font-medium text-gray-700 mb-1">
                            {% trans "Footer Name" %}
                        </label>
                        <input type="text" id="footerName" name="name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="{% trans 'Enter footer name...' %}">
                    </div>
                    <div class="flex-1 flex flex-col min-h-0">
                        <label for="footerContent" class="block text-sm font-medium text-gray-700 mb-1 flex-shrink-0">
                            {% trans "Footer Content (HTML)" %}
                        </label>
                        <div class="flex-1 min-h-0">
                            <div id="footerEditor" class="border border-gray-300 rounded-md h-full"></div>
                        </div>
                        <textarea id="footerContent" name="html_content" style="display: none;"></textarea>
                        <p class="mt-1 text-sm text-gray-500 flex-shrink-0">
                            {% trans "Enter the HTML content for your footer. You can use variables like {{first_name}}, {{last_name}}, {{email}}, etc." %}
                        </p>
                    </div>
                    <div class="flex items-center flex-shrink-0">
                        <input type="checkbox" id="isDefault" name="is_default" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="isDefault" class="ml-2 block text-sm text-gray-900">
                            {% trans "Set as default footer" %}
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6 flex-shrink-0 border-t border-gray-200 pt-4">
                    <button type="button" id="cancelNewFooter" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        {% trans "Create Footer" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables for Quill editors
let quill;
let footerQuill;

// Function to copy variable to clipboard and insert into editor
function copyVariable(variable, element) {
    // Copy to clipboard
    navigator.clipboard.writeText(variable).then(function() {
        // Insert into Quill editor at current cursor position
        if (quill) {
            const range = quill.getSelection();
            if (range) {
                quill.insertText(range.index, variable);
                quill.setSelection(range.index + variable.length);
            } else {
                // If no selection, append to end
                const length = quill.getLength();
                quill.insertText(length - 1, variable);
                quill.setSelection(length + variable.length - 1);
            }
        }
        
        // Show brief success feedback
        if (element) {
            const originalBg = element.style.backgroundColor;
            element.style.backgroundColor = '#10B981';
            setTimeout(() => {
                element.style.backgroundColor = originalBg;
            }, 200);
        }
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        alert('{% trans "Could not copy variable. Please try again." %}');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Quill editor
    quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ]
        },
        placeholder: '{% trans "Enter your email content here..." %}'
    });
    
    // Initialize footer editor
    footerQuill = new Quill('#footerEditor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link'],
                ['clean']
            ]
        },
        placeholder: '{% trans "Enter footer content here..." %}'
    });
    
    const previewBtn = document.getElementById('previewBtn');
    const testBtn = document.getElementById('testBtn');
    const previewModal = document.getElementById('previewModal');
    const testModal = document.getElementById('testModal');
    const templateForm = document.getElementById('templateForm');
    const testForm = document.getElementById('testForm');
    const campaignId = '{{ campaign.id }}';
    const templateId = '{{ template.id }}';
    
    // Footer modal elements
    const newFooterBtn = document.getElementById('newFooterBtn');
    const newFooterModal = document.getElementById('newFooterModal');
    const cancelNewFooter = document.getElementById('cancelNewFooter');
    const newFooterForm = document.getElementById('newFooterForm');
    
    // Load template data if editing
    if (templateId) {
        fetch(`/api/campaigns/${campaignId}/emails/${templateId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('subject').value = data.subject;
                document.getElementById('wait_time').value = data.wait_time;
                document.getElementById('wait_unit').value = data.wait_unit;
                
                // Set content in Quill editor
                quill.root.innerHTML = data.body_html;
                
                // Set footer if available
                if (data.footer_id) {
                    document.getElementById('footer_select').value = data.footer_id;
                }
            })
            .catch(error => {
                console.error('Error loading template:', error);
                alert('{% trans "An error occurred while loading the template. Please try again." %}');
            });
    }
    
    // Preview functionality
    previewBtn.addEventListener('click', function() {
        const content = quill.root.innerHTML;
        
        // Get selected footer content
        const footerSelect = document.getElementById('footer_select');
        const selectedFooterId = footerSelect.value;
        let footerContent = '';
        
        if (selectedFooterId) {
            // Find the footer content from the options
            const footerOption = footerSelect.querySelector(`option[value="${selectedFooterId}"]`);
            if (footerOption) {
                // This is a simplified approach - in a real implementation, you'd fetch the footer content
                footerContent = '<hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;"><div style="font-size: 12px; color: #6b7280;">[Footer content would appear here]</div>';
            }
        }
        
        document.getElementById('previewContent').innerHTML = content + footerContent;
        previewModal.classList.remove('hidden');
    });
    
    // Test email functionality
    testBtn.addEventListener('click', function() {
        testModal.classList.remove('hidden');
    });
    
    // Footer modal functionality
    newFooterBtn.addEventListener('click', function() {
        newFooterModal.classList.remove('hidden');
        document.getElementById('footerName').focus();
    });
    
    cancelNewFooter.addEventListener('click', function() {
        newFooterModal.classList.add('hidden');
        newFooterForm.reset();
        footerQuill.setContents([]);
    });
    
    // Close footer modal when clicking outside
    newFooterModal.addEventListener('click', function(e) {
        if (e.target === newFooterModal) {
            newFooterModal.classList.add('hidden');
            newFooterForm.reset();
            footerQuill.setContents([]);
        }
    });
    
    // Form submission
    templateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = templateForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '{% trans "Saving..." %}';
        submitBtn.disabled = true;
        
        // Get content from Quill editor
        const htmlContent = quill.root.innerHTML;
        
        // Get selected footer
        const footerSelect = document.getElementById('footer_select');
        const selectedFooterId = footerSelect.value;
        
        const data = {
            subject: document.getElementById('subject').value,
            wait_time: parseInt(document.getElementById('wait_time').value),
            wait_unit: document.getElementById('wait_unit').value,
            body_html: htmlContent,
            body_text: htmlContent.replace(/<[^>]*>/g, '') // Convert HTML to plain text
        };
        
        // Only add footer_id if a footer is selected
        if (selectedFooterId && selectedFooterId.trim()) {
            data.footer_id = selectedFooterId;
        }
        
        const url = templateId 
            ? `/api/campaigns/${campaignId}/emails/${templateId}/`
            : `/api/campaigns/${campaignId}/emails/`;
        
        console.log('Submitting data:', data);
        console.log('URL:', url);
        
        fetch(url, {
            method: templateId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.error || 'Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            // Show success message
            alert('{% trans "Template saved successfully!" %}');
            // Redirect to campaign edit page
            window.location.href = `/campaigns/${campaignId}/edit/`;
        })
        .catch(error => {
            console.error('Error:', error);
            let errorMessage = '{% trans "An error occurred while saving the template. Please try again." %}';
            if (error.message) {
                errorMessage += '\n\nError: ' + error.message;
            }
            alert(errorMessage);
        })
        .finally(() => {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Test email form submission
    testForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('test_email').value;
        const firstName = document.getElementById('test_first_name').value;
        const lastName = document.getElementById('test_last_name').value;
        const fullName = `${firstName} ${lastName}`.trim();
        
        const data = {
            email: email,
            variables: {
                first_name: firstName,
                last_name: lastName,
                full_name: fullName,
                email: email
            }
        };
        
        // The URL must include the email_id (templateId)
        if (!templateId) {
            alert('{% trans "Please save the email template first before sending a test email." %}');
            return;
        }
        
        const url = `/api/campaigns/${campaignId}/emails/${templateId}/test/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            closeTestModal();
            alert('{% trans "Test email sent successfully!" %}');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "An error occurred while sending the test email. Please try again." %}');
        });
    });
});

function closePreviewModal() {
    document.getElementById('previewModal').classList.add('hidden');
}

function closeTestModal() {
    document.getElementById('testModal').classList.add('hidden');
}

function copyApiKey() {
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const copyButton = apiKeyInput.nextElementSibling;
    const originalText = copyButton.textContent;
    copyButton.textContent = '{% trans "Copied!" %}';
    setTimeout(() => {
        copyButton.textContent = originalText;
    }, 2000);
}

function regenerateApiKey() {
    if (!confirm('{% trans "Are you sure you want to regenerate your API key? This will invalidate your current key and you will need to update any applications using it." %}')) {
        return;
    }
    
    const regenerateButton = document.querySelector('button[onclick="regenerateApiKey()"]');
    const originalText = regenerateButton.textContent;
    regenerateButton.textContent = '{% trans "Regenerating..." %}';
    regenerateButton.disabled = true;
    
    fetch('/api/regenerate-key/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the API key input
            document.getElementById('apiKey').value = data.api_key;
            
            // Update all API examples with the new key
            updateApiExamples(data.api_key);
            
            alert('{% trans "API key regenerated successfully!" %}');
        } else {
            alert('{% trans "Error regenerating API key. Please try again." %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error regenerating API key. Please try again." %}');
    })
    .finally(() => {
        regenerateButton.textContent = originalText;
        regenerateButton.disabled = false;
    });
}

function updateApiExamples(newApiKey) {
    // Update all API examples with the new key
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        let content = block.textContent;
        // Replace the API key in all code examples
        content = content.replace(/Bearer [A-Za-z0-9]+/g, `Bearer ${newApiKey}`);
        block.textContent = content;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Footer form submission
document.getElementById('newFooterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('footerName').value;
    const htmlContent = footerQuill.root.innerHTML;
    const isDefault = document.getElementById('isDefault').checked;
    
    if (!name.trim()) {
        alert('{% trans "Please enter a footer name." %}');
        return;
    }
    
    if (!htmlContent.trim()) {
        alert('{% trans "Please enter footer content." %}');
        return;
    }
    
    const data = {
        name: name,
        html_content: htmlContent,
        is_default: isDefault
    };
    
    fetch('/api/footers/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Add new footer to dropdown
            const select = document.getElementById('footer_select');
            const option = document.createElement('option');
            option.value = data.footer_id;
            option.textContent = name;
            if (isDefault) {
                option.selected = true;
            }
            select.appendChild(option);
            
            // Close modal and reset form
            document.getElementById('newFooterModal').classList.add('hidden');
            document.getElementById('newFooterForm').reset();
            footerQuill.setContents([]);
            
            // Show success message
            alert('{% trans "Footer created successfully!" %}');
        } else {
            alert('{% trans "Error creating footer. Please try again." %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error creating footer. Please try again." %}');
    });
});
</script>
{% endblock %}
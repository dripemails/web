{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Dashboard - DripEmails.org{% endblock %}

{% block extra_head %}
<style>
    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: .5;
        }
    }
    .email-preview-content {
        font-family: Arial, sans-serif;
        font-size: 14px;
        line-height: 1.6;
        color: #333;
    }
    .email-preview-content img {
        max-width: 100%;
        height: auto;
    }
    .email-preview-content a {
        color: #3B82F6;
        text-decoration: underline;
    }
    .email-preview-content p {
        margin: 0.5em 0;
    }
    .email-preview-content h1,
    .email-preview-content h2,
    .email-preview-content h3 {
        margin: 1em 0 0.5em 0;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen pb-12">
    <div class="bg-indigo-600 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">Dashboard</h1>
                    <p class="text-indigo-100">Manage your campaigns and subscribers</p>
                </div>
                <a href="{% url 'core:settings' %}" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all duration-200 text-white font-medium">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>{% trans "Settings" %}</span>
                </a>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600 mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Campaigns</p>
                        <p class="text-2xl font-semibold">{{ campaigns_count }}</p>
                        <a href="{% url 'campaigns:create' %}"
                           class="mt-3 inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800">
                            Add a new Campaign
                            <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Subscribers</p>
                        <p class="text-2xl font-semibold">{{ subscribers_count }}</p>
                        <a href="{% url 'subscribers:list' %}"
                           class="mt-3 inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800">
                            View subscribers
                            <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Emails Sent</p>
                        <p class="text-2xl font-semibold">{{ sent_emails_count }}</p>
                        <a href="{% url 'analytics:dashboard' %}"
                           class="mt-3 inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800">
                            View Analytics
                            <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Lists</p>
                        <p class="text-2xl font-semibold">{{ lists_count }}</p>
                        <a href="{% url 'subscribers:import' %}"
                           class="mt-3 inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800">
                            Add a List
                            <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SPF Record Setup Instructions - Full Width -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">SPF Record Setup for Email Deliverability</h3>
                    <p class="text-gray-700 mb-4">
                        To ensure your emails are delivered successfully and avoid spam filters, you need to add an SPF (Sender Policy Framework) record to your domain's DNS settings. This authorizes DripEmails.org to send emails on behalf of your domain.
                    </p>
                    <div class="bg-white rounded-md p-4 mb-4 border border-gray-200">
                        <p class="text-sm font-medium text-gray-700 mb-2">Add this TXT record to your domain's DNS:</p>
                        <div class="bg-gray-50 rounded p-3 font-mono text-sm">
                            <div class="mb-2">
                                <span class="text-gray-600">Type:</span> <span class="text-gray-900 font-semibold">TXT</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-gray-600">Name/Host:</span> <span class="text-gray-900 font-semibold">@</span> <span class="text-gray-500 text-xs">(or your domain name)</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-gray-600">Value:</span>
                            </div>
                            <div class="bg-white p-2 rounded border border-gray-300 text-gray-900 break-all">
                                v=spf1 include:dripemails.org include:web.dripemails.org include:web1.dripemails.org ~all
                            </div>
                        </div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4">
                        <p class="text-sm text-yellow-800">
                            <strong>Note:</strong> If you already have an SPF record, you should modify it to include these servers instead of creating a new one. Multiple SPF records are not allowed.
                        </p>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p class="mb-2"><strong>How to add this record:</strong></p>
                        <ol class="list-decimal list-inside space-y-1 ml-2">
                            <li>Log in to your domain registrar for {% if user_email_domain %}{{ user_email_domain }}{% else %}your domain{% endif %} or DNS provider (e.g., GoDaddy, Namecheap, Cloudflare)</li>
                            <li>Navigate to DNS management or DNS settings</li>
                            <li>Add a new TXT record with the values shown above</li>
                            <li>Save the changes (DNS propagation can take up to 48 hours)</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Send Email Form -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Send Email & Subscribe</h3>
            <form id="sendEmailForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="send_first_name" name="first_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="send_last_name" name="last_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="send_email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Campaign</label>
                    <select id="send_campaign" name="campaign" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select a campaign...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Template</label>
                    <select id="send_email_template" name="email_template" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" disabled>
                        <option value="">Select a campaign first...</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Schedule</label>
                        <select id="send_schedule" name="schedule" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="now">Send Now</option>
                            <option value="minutes">Send in X Minutes</option>
                            <option value="hours">Send in X Hours</option>
                            <option value="days">Send in X Days</option>
                            <option value="weeks">Send in X Weeks</option>
                            <option value="months">Send in X Months</option>
                        </select>
                    </div>
                    <div id="schedule_value_container" class="hidden">
                        <label id="schedule_value_label" class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                        <input type="number" id="schedule_value" name="schedule_value" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                    Send Email & Subscribe
                </button>
            </form>
        </div>

        <!-- Recent Send Activity -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Recent Send Activity</h3>
                <button id="refreshSendActivity" type="button" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Refresh
                </button>
            </div>
            <div class="flex items-center gap-2 mb-4">
                <p class="text-xs text-gray-500">Times shown in</p>
                <select id="timezoneSelector" class="text-xs border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <!-- Timezones will be populated by JavaScript -->
                </select>
            </div>
            <div id="sendEmailActivity" class="space-y-4">
                <p class="text-sm text-gray-500">Loading activity...</p>
            </div>
        </div>

        <!-- Advertisement Status -->
        {% if not user.profile.has_verified_promo %}
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8 border-l-4 border-yellow-500">
            <div class="flex items-start md:items-center flex-col md:flex-row">
                <div class="mr-4 text-yellow-500 mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold text-gray-800">Remove Advertisements from Your Emails</h3>
                    <p class="text-gray-600 mb-4">Your emails currently include our branding. Share about DripEmails.org on X or your blog to remove ads from all your emails.</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <a href="{% url 'core:promo_verification' %}" class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Remove Ads</a>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Main Dashboard -->
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Left Column -->
            <div class="md:w-2/3">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-8">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800">Your Campaigns</h2>
                        <a href="{% url 'campaigns:create' %}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            New Campaign
                        </a>
                    </div>
                    
                    {% if campaigns %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emails</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sent</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for campaign in campaigns %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="font-medium text-gray-900">
                                            <a href="{% url 'campaigns:edit' campaign.id %}" class="text-indigo-600 hover:text-indigo-900 hover:underline">{{ campaign.name }}</a>
                                        </div>
                                        <div class="text-sm text-gray-500">{{ campaign.description|truncatechars:50 }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if campaign.is_active %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                        {% else %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ campaign.emails_count }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ campaign.sent_count }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ campaign.created_at|date:"M d, Y" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <a href="{% url 'campaigns:analysis' %}?campaign_id={{ campaign.id }}" class="text-indigo-600 hover:text-indigo-900 mr-3">Analytics</a>
                                        <a href="{% url 'campaigns:edit' campaign.id %}" class="text-indigo-600 hover:text-indigo-900">Edit</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="px-6 py-12 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No campaigns yet</h3>
                        <p class="text-gray-500 max-w-md mx-auto mb-6">Create your first campaign to start sending automated emails to your subscribers.</p>
                        <a href="{% url 'campaigns:create' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Create First Campaign
                        </a>
                    </div>
                    {% endif %}
                </div>
                
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800">Your Subscriber Lists</h2>
                        <a href="{% url 'subscribers:import' %}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            New List
                        </a>
                    </div>
                    
                    {% if lists %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscribers</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for list in lists %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="font-medium text-gray-900">
                                            <a href="{% url 'subscribers:list-detail' list.id %}" class="text-indigo-600 hover:text-indigo-900 hover:underline">{{ list.name }}</a>
                                        </div>
                                        <div class="text-sm text-gray-500">{{ list.description|truncatechars:50 }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ list.subscribers_count }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ list.active_subscribers_count }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ list.created_at|date:"M d, Y" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <a href="{% url 'subscribers:list-detail' list.id %}" class="text-indigo-600 hover:text-indigo-900 mr-3">View</a>
                                        <a href="{% url 'subscribers:list-detail' list.id %}" class="text-indigo-600 hover:text-indigo-900">Edit</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="px-6 py-12 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No subscriber lists yet</h3>
                        <p class="text-gray-500 max-w-md mx-auto mb-6">Create your first subscriber list to start organizing your contacts.</p>
                        <a href="{% url 'subscribers:import' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Create First List
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="md:w-1/3">
                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <a href="{% url 'campaigns:create' %}" class="flex items-center p-3 bg-gray-50 hover:bg-indigo-50 text-gray-800 hover:text-indigo-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Create New Campaign
                        </a>
                        <a href="{% url 'subscribers:import' %}" class="flex items-center p-3 bg-gray-50 hover:bg-indigo-50 text-gray-800 hover:text-indigo-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                            Add Subscribers
                        </a>
                        <a href="{% url 'core:feature_analytics' %}" class="flex items-center p-3 bg-gray-50 hover:bg-indigo-50 text-gray-800 hover:text-indigo-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            View Analytics
                        </a>
                        <a href="{% url 'campaigns:new-template' %}" class="flex items-center p-3 bg-gray-50 hover:bg-indigo-50 text-gray-800 hover:text-indigo-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Create Email Template
                        </a>
                        <a href="{% url 'campaigns:drafts' %}" class="flex items-center p-3 bg-gray-50 hover:bg-indigo-50 text-gray-800 hover:text-indigo-700 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            View Email Templates
                        </a>
                    </div>
                </div>
                
                <!-- Account Status -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Account Settings</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Ad Removal</span>
                            {% if user.profile.has_verified_promo %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Enabled
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Disabled
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Unsubscribe Links</span>
                            {% if user.profile.send_without_unsubscribe %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Disabled
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Enabled
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Timezone</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ user_timezone|default:'UTC' }}
                            </span>
                        </div>
                        <div class="pt-4 border-t border-gray-200">
                            <div class="space-y-2">
                                <a href="{% url 'core:settings' %}" class="block text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    Manage Account Settings →
                                </a>
                                <a href="{% url 'analytics:footer_list' %}" class="block text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    Manage Email Footers →
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tips & Resources -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tips & Resources</h3>
                    <div class="space-y-4">
                        <a href="{% url 'core:resource_tutorials' %}" class="block p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                            <h4 class="font-medium text-indigo-800 mb-1">Getting Started Guide</h4>
                            <p class="text-sm text-indigo-600">Learn how to set up your first email campaign in minutes.</p>
                        </a>
                        <a href="{% url 'core:resource_documentation' %}" class="block p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                            <h4 class="font-medium text-green-800 mb-1">Email Best Practices</h4>
                            <p class="text-sm text-green-600">Tips for creating emails that convert.</p>
                        </a>
                        <a href="{% url 'core:feature_subscriber_management' %}" class="block p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
                            <h4 class="font-medium text-yellow-800 mb-1">Grow Your Subscriber List</h4>
                            <p class="text-sm text-yellow-600">Strategies to increase your subscribers.</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Make toggleEmailPreview globally accessible
function toggleEmailPreview(previewId) {
    const snippet = document.getElementById(previewId + '-snippet');
    const full = document.getElementById(previewId + '-full');
    if (snippet && full) {
        if (full.classList.contains('hidden')) {
            full.classList.remove('hidden');
            snippet.classList.add('hidden');
        } else {
            full.classList.add('hidden');
            snippet.classList.remove('hidden');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('sendEmailForm');
    const campaignSelect = document.getElementById('send_campaign');
    const emailTemplateSelect = document.getElementById('send_email_template');
    const scheduleSelect = document.getElementById('send_schedule');
    const scheduleValueContainer = document.getElementById('schedule_value_container');
    const scheduleValueInput = document.getElementById('schedule_value');
    const scheduleValueLabel = document.getElementById('schedule_value_label');
    const activityContainer = document.getElementById('sendEmailActivity');
    const refreshSendActivityButton = document.getElementById('refreshSendActivity');
    const timezoneSelector = document.getElementById('timezoneSelector');
    let currentTimezone = '{{ user_timezone|default:"UTC" }}';

    // Common timezones list (including UTC)
    const commonTimezones = [
        'UTC',
        'America/New_York',
        'America/Chicago',
        'America/Denver',
        'America/Los_Angeles',
        'America/Phoenix',
        'America/Anchorage',
        'America/Honolulu',
        'Europe/London',
        'Europe/Paris',
        'Europe/Berlin',
        'Europe/Rome',
        'Europe/Madrid',
        'Europe/Amsterdam',
        'Europe/Stockholm',
        'Europe/Moscow',
        'Asia/Tokyo',
        'Asia/Shanghai',
        'Asia/Hong_Kong',
        'Asia/Singapore',
        'Asia/Dubai',
        'Asia/Kolkata',
        'Asia/Seoul',
        'Australia/Sydney',
        'Australia/Melbourne',
        'Australia/Perth',
        'Pacific/Auckland',
        'America/Toronto',
        'America/Vancouver',
        'America/Mexico_City',
        'America/Sao_Paulo',
        'America/Buenos_Aires'
    ];

    // Populate timezone selector
    if (timezoneSelector) {
        commonTimezones.forEach(tz => {
            const option = document.createElement('option');
            option.value = tz;
            option.textContent = tz;
            if (tz === currentTimezone) {
                option.selected = true;
            }
            timezoneSelector.appendChild(option);
        });

        // Handle timezone change
        timezoneSelector.addEventListener('change', function() {
            const selectedTimezone = this.value;
            saveTimezone(selectedTimezone);
        });
    }

    // Save timezone preference
    function saveTimezone(timezone) {
        fetch('/api/profile/settings/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ timezone: timezone })
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status >= 200 && status < 300) {
                currentTimezone = timezone;
                // Reload activity with new timezone
                loadSendEmailActivity();
            } else {
                alert(body.error || 'Failed to save timezone preference.');
                // Revert selector to previous value
                if (timezoneSelector) {
                    timezoneSelector.value = currentTimezone;
                }
            }
        })
        .catch(error => {
            console.error('Error saving timezone:', error);
            alert('Error saving timezone preference. Please try again.');
            // Revert selector to previous value
            if (timezoneSelector) {
                timezoneSelector.value = currentTimezone;
            }
        });
    }

    const statusBadgeClasses = {
        pending: 'bg-yellow-100 text-yellow-800',
        queued: 'bg-blue-100 text-blue-800',
        sent: 'bg-green-100 text-green-800',
        failed: 'bg-red-100 text-red-800'
    };

    function formatDisplayDate(iso, fallbackDisplay) {
        if (fallbackDisplay) {
            return fallbackDisplay;
        }
        if (!iso) {
            return '—';
        }
        const date = new Date(iso);
        if (isNaN(date.getTime())) {
            return '—';
        }
        return date.toLocaleString();
    }

    function renderSendEmailActivity(requests) {
        if (!activityContainer) return;

        if (!requests.length) {
            activityContainer.innerHTML = '<p class="text-sm text-gray-500">No send activity yet. Use the form above to send an email.</p>';
            return;
        }

        const cards = requests.map(req => {
            const statusClass = statusBadgeClasses[req.status] || 'bg-gray-100 text-gray-800';
            const scheduledText = formatDisplayDate(req.scheduled_for, req.scheduled_for_display);
            const sentText = formatDisplayDate(req.sent_at, req.sent_at_display);
            const canSendNow = req.status !== 'sent';

            const previewId = `preview-${req.id}`;
            const previewSnippet = req.email_preview_snippet || 'No preview available';
            const fullHtml = req.email_preview_html || '';
            const fullText = req.email_preview_text || '';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="text-sm font-semibold text-gray-800">${req.email_subject || 'Untitled Email'}</h4>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium ${statusClass}">
                                    ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500">
                                ${req.campaign} &bull; ${req.subscriber_name || req.subscriber_email}
                            </p>
                            <div class="mt-2 text-xs text-gray-500 space-y-1">
                                <div><span class="font-medium text-gray-600">To:</span> ${req.subscriber_email || 'N/A'}</div>
                                <div><span class="font-medium text-gray-600">Scheduled:</span> ${scheduledText}</div>
                                <div><span class="font-medium text-gray-600">Sent:</span> ${sentText}</div>
                                ${req.error_message ? `<div class="text-red-600">${req.error_message}</div>` : ''}
                            </div>
                            <!-- Email Preview -->
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="text-xs text-gray-600 mb-1">Email Preview:</div>
                                <div id="${previewId}-snippet" class="bg-white border border-gray-300 rounded p-3">
                                    <div class="relative" style="max-height: 300px; overflow-y: auto;">
                                        <div class="email-preview-content">${fullHtml}</div>
                                    </div>
                                    <button type="button" onclick="toggleEmailPreview('${previewId}')" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-medium">Show full email...</button>
                                </div>
                                <div id="${previewId}-full" class="hidden mt-2">
                                    <div class="bg-white border border-gray-300 rounded p-3 max-h-96 overflow-y-auto">
                                        <div class="text-xs text-gray-500 mb-2 font-medium">Full HTML Preview:</div>
                                        <div class="border-b border-gray-200 pb-3 mb-3" style="max-height: 400px; overflow-y: auto;">
                                            <div class="email-preview-content">${fullHtml}</div>
                                        </div>
                                        <div class="text-xs text-gray-500 mb-1 font-medium">Text Version:</div>
                                        <div class="text-xs whitespace-pre-wrap font-mono bg-gray-50 p-2 rounded border border-gray-200">${fullText}</div>
                                    </div>
                                    <button type="button" onclick="toggleEmailPreview('${previewId}')" class="mt-2 text-xs text-indigo-600 hover:text-indigo-800">Show less</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                type="button"
                                class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                data-action="send-now"
                                data-request-id="${req.id}"
                                ${canSendNow ? '' : 'disabled'}
                            >
                                Send Now
                            </button>
                            <button
                                type="button"
                                class="inline-flex items-center px-3 py-1.5 border border-red-200 rounded-md text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100"
                                data-action="unsubscribe"
                                data-request-id="${req.id}"
                            >
                                Unsubscribe
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        activityContainer.innerHTML = cards;
    }

    function loadSendEmailActivity() {
        if (!activityContainer) return;
        activityContainer.innerHTML = '<p class="text-sm text-gray-500">Loading activity...</p>';
        // Use current timezone from selector or default
        const tz = timezoneSelector ? timezoneSelector.value : currentTimezone;
        fetch('/api/send-email/requests/')
            .then(response => response.json())
            .then(data => {
                const requests = data.requests || [];
                // Update timezone if it changed on server
                if (data.timezone && timezoneSelector) {
                    currentTimezone = data.timezone;
                    timezoneSelector.value = data.timezone;
                }
                renderSendEmailActivity(requests);
            })
            .catch(error => {
                console.error('Error loading send activity:', error);
                activityContainer.innerHTML = '<p class="text-sm text-red-600">Failed to load activity. Please try again.</p>';
            });
    }

    function performSendEmailAction(action, requestId) {
        if (!requestId) return;
        const url = action === 'send-now'
            ? `/api/send-email/requests/${requestId}/send-now/`
            : `/api/send-email/requests/${requestId}/unsubscribe/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status >= 200 && status < 300) {
                alert(body.message || 'Action completed successfully.');
                loadSendEmailActivity();
            } else {
                alert(body.error || 'Action failed.');
            }
        })
        .catch(error => {
            console.error('Error performing action:', error);
            alert('Error performing action. Please try again.');
        });
    }

    if (activityContainer) {
        loadSendEmailActivity();
        activityContainer.addEventListener('click', function(e) {
            const button = e.target.closest('[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const requestId = button.dataset.requestId;
            performSendEmailAction(action, requestId);
        });
    }

    if (refreshSendActivityButton) {
        refreshSendActivityButton.addEventListener('click', function() {
            loadSendEmailActivity();
        });
    }

    // Load campaigns
    fetch('/api/campaigns/')
        .then(response => response.json())
        .then(data => {
            const campaigns = Array.isArray(data) ? data : (data.results || []);
            campaigns.forEach(campaign => {
                const option = document.createElement('option');
                option.value = campaign.id;
                option.textContent = campaign.name;
                campaignSelect.appendChild(option);
            });
        });

    // Handle campaign selection
    campaignSelect.addEventListener('change', function() {
        const campaignId = this.value;
        if (campaignId) {
            // Fetch emails for this campaign
            emailTemplateSelect.disabled = false;
            emailTemplateSelect.innerHTML = '<option value="">Loading...</option>';
            
            fetch(`/api/campaigns/${campaignId}/emails/`)
                .then(response => response.json())
                .then(data => {
                    const emails = Array.isArray(data) ? data : [];
                    emailTemplateSelect.innerHTML = '<option value="">Select an email template...</option>';
                    emails.forEach(email => {
                        const option = document.createElement('option');
                        option.value = email.id;
                        option.textContent = email.subject || `Email ${email.order}`;
                        emailTemplateSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading emails:', error);
                    emailTemplateSelect.innerHTML = '<option value="">Error loading emails</option>';
                });
        } else {
            emailTemplateSelect.disabled = true;
            emailTemplateSelect.innerHTML = '<option value="">Select a campaign first...</option>';
        }
    });

    // Handle schedule change
    scheduleSelect.addEventListener('change', function() {
        if (this.value === 'now') {
            scheduleValueContainer.classList.add('hidden');
            scheduleValueInput.value = '';
        } else {
            scheduleValueContainer.classList.remove('hidden');
            // Update label based on selection
            const labelMap = {
                'minutes': 'X Minutes',
                'hours': 'X Hours',
                'days': 'X Days',
                'weeks': 'X Weeks',
                'months': 'X Months'
            };
            scheduleValueLabel.textContent = labelMap[this.value] || 'Value';
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            first_name: document.getElementById('send_first_name').value,
            last_name: document.getElementById('send_last_name').value,
            email: document.getElementById('send_email').value,
            campaign_id: campaignSelect.value,
            email_id: emailTemplateSelect.value,
            schedule: scheduleSelect.value,
            schedule_value: scheduleValueInput.value || '0'
        };

        fetch('/api/send-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(async response => {
            let data = null;
            try {
                data = await response.json();
            } catch (jsonError) {
                console.warn('Could not parse response as JSON:', jsonError);
                const textResponse = await response.text();
                console.warn('Response text:', textResponse);
                throw new Error('Invalid response from server');
            }
            
            if (!response.ok) {
                const errorMessage = data?.error || data?.detail || JSON.stringify(data) || 'Failed to send email.';
                throw new Error(errorMessage);
            }
            
            return data;
        })
        .then(data => {
            alert(data.message || 'Email scheduled successfully!');
            form.reset();
            scheduleValueContainer.classList.add('hidden');
            loadSendEmailActivity();
            // Reload page to update subscriber count
            location.reload();
        })
        .catch(error => {
            console.error('Error details:', error);
            console.error('Error name:', error.name);
            console.error('Error message:', error.message);
            if (error.stack) {
                console.error('Error stack:', error.stack);
            }
            const errorMessage = error.message || 'Error sending email. Please try again.';
            alert('Error: ' + errorMessage);
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Toggle campaign status (activate/deactivate) - must be global for onclick handler
function toggleCampaignStatus(campaignId, activate) {
    const endpoint = activate 
        ? `/api/campaigns/${campaignId}/activate/`
        : `/api/campaigns/${campaignId}/deactivate/`;
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': (function() {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, 'csrftoken'.length + 1) === ('csrftoken' + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring('csrftoken'.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            })()
        }
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 200 && status < 300) {
            alert(body.message || (activate ? 'Campaign activated successfully!' : 'Campaign deactivated successfully!'));
            // Reload the page to show updated status
            window.location.reload();
        } else {
            alert(body.error || 'Failed to update campaign status. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error toggling campaign status:', error);
        alert('Error updating campaign status. Please try again.');
    });
}
</script>

{% endblock %}